<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>SpentShare</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ff6b35">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- iPhone / iOS specific -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="SpentShare">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="apple-touch-startup-image" href="icons/icon-512.png">

  <!-- Splash screen color for iPhone -->
  <meta name="msapplication-TileColor" content="#ff6b35">
  <meta name="msapplication-TileImage" content="icons/icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;900&family=Nunito+Sans:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --orange: #ff6b35;
    --orange-light: #fff5f0;
    --green: #3ecf8e;
    --green-light: #f0fdf8;
    --blue: #4f8ef7;
    --blue-light: #eff6ff;
    --red: #f56565;
    --red-light: #fff5f5;
    --cream: #f7f3ee;
    --white: #ffffff;
    --text: #1a1a2e;
    --text2: #555;
    --muted: #aaa;
    --border: #ede9e3;
    --card-shadow: 0 4px 20px rgba(0,0,0,0.06);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'Nunito Sans', sans-serif;
    background: var(--cream);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    /* iPhone safe areas */
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SPLASH SCREEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #splash {
    position: fixed;
    inset: 0;
    background: var(--cream);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 28px;
    z-index: 1000;
    transition: opacity 0.7s ease, transform 0.7s ease;
  }

  #splash.hide {
    opacity: 0;
    transform: scale(1.05);
    pointer-events: none;
  }

  .coin-wrapper {
    position: relative;
    width: 110px; height: 110px;
  }

  .coin {
    width: 110px; height: 110px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--orange), #f7931e);
    display: flex; align-items: center; justify-content: center;
    font-size: 48px;
    box-shadow: 0 12px 40px rgba(255,107,53,0.35);
    opacity: 0;
    transform: scale(0) rotate(-180deg);
    animation: coinSpin 0.8s 0.3s cubic-bezier(0.34,1.56,0.64,1) forwards;
  }

  @keyframes coinSpin { to { opacity:1; transform: scale(1) rotate(0deg); } }

  .split-line {
    position: absolute;
    background: var(--cream);
    width: 3px; height: 0;
    top: 50%; left: 50%;
    transform-origin: top center;
    border-radius: 2px;
    animation: growLine 0.5s 1.1s ease forwards;
  }
  .split-line:nth-child(2) { transform: translateX(-50%) rotate(0deg); }
  .split-line:nth-child(3) { transform: translateX(-50%) rotate(60deg); }
  .split-line:nth-child(4) { transform: translateX(-50%) rotate(120deg); }
  @keyframes growLine { to { height: 55px; } }

  .dot {
    position: absolute;
    width: 13px; height: 13px;
    border-radius: 50%;
    top: 50%; left: 50%;
    opacity: 0;
  }
  .dot:nth-child(5) { background: var(--orange); animation: flyDot 0.5s 1.5s cubic-bezier(0.34,1.56,0.64,1) forwards; --tx:-60px; --ty:-60px; }
  .dot:nth-child(6) { background: var(--green);  animation: flyDot 0.5s 1.6s cubic-bezier(0.34,1.56,0.64,1) forwards; --tx:60px;  --ty:-60px; }
  .dot:nth-child(7) { background: var(--blue);   animation: flyDot 0.5s 1.7s cubic-bezier(0.34,1.56,0.64,1) forwards; --tx:0px;   --ty:70px; }
  @keyframes flyDot { to { opacity:1; transform: translate(var(--tx),var(--ty)); } }

  .splash-text { display: flex; align-items: baseline; }

  .letter {
    font-family: 'Nunito', sans-serif;
    font-size: 46px; font-weight: 900;
    opacity: 0; transform: translateY(30px);
    display: inline-block;
  }
  .spent-l .letter { color: var(--text); }
  .share-l .letter { color: var(--orange); }

  .spent-l .letter:nth-child(1) { animation: lPop 0.4s 1.80s cubic-bezier(0.34,1.56,0.64,1) forwards; }
  .spent-l .letter:nth-child(2) { animation: lPop 0.4s 1.88s cubic-bezier(0.34,1.56,0.64,1) forwards; }
  .spent-l .letter:nth-child(3) { animation: lPop 0.4s 1.96s cubic-bezier(0.34,1.56,0.64,1) forwards; }
  .spent-l .letter:nth-child(4) { animation: lPop 0.4s 2.04s cubic-bezier(0.34,1.56,0.64,1) forwards; }
  .spent-l .letter:nth-child(5) { animation: lPop 0.4s 2.12s cubic-bezier(0.34,1.56,0.64,1) forwards; }
  .share-l .letter:nth-child(1) { animation: lPop 0.4s 2.20s cubic-bezier(0.34,1.56,0.64,1) forwards; }
  .share-l .letter:nth-child(2) { animation: lPop 0.4s 2.28s cubic-bezier(0.34,1.56,0.64,1) forwards; }
  .share-l .letter:nth-child(3) { animation: lPop 0.4s 2.36s cubic-bezier(0.34,1.56,0.64,1) forwards; }
  .share-l .letter:nth-child(4) { animation: lPop 0.4s 2.44s cubic-bezier(0.34,1.56,0.64,1) forwards; }
  .share-l .letter:nth-child(5) { animation: lPop 0.4s 2.52s cubic-bezier(0.34,1.56,0.64,1) forwards; }
  @keyframes lPop { to { opacity:1; transform:translateY(0); } }

  .splash-tagline {
    font-size: 13px; font-weight: 400;
    color: var(--muted); letter-spacing: 2.5px;
    text-transform: uppercase;
    opacity: 0;
    animation: fadeUp 0.6s 3s ease forwards;
  }

  .splash-loader {
    width: 160px; height: 3px;
    background: #e8e3dd; border-radius: 10px;
    overflow: hidden; opacity: 0;
    animation: fadeUp 0.3s 3.2s ease forwards;
  }
  .splash-loader-bar {
    height: 100%; width: 0;
    background: linear-gradient(90deg, var(--orange), var(--green));
    border-radius: 10px;
    animation: loadBar 1.2s 3.3s ease forwards;
  }
  @keyframes loadBar { to { width: 100%; } }
  @keyframes fadeUp {
    from { opacity:0; transform:translateY(8px); }
    to   { opacity:1; transform:translateY(0); }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOGIN SCREEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #loginScreen {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 900;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.7s ease 0.2s, transform 0.7s ease 0.2s;
    pointer-events: none;
    background: var(--cream);
  }

  #loginScreen.show {
    opacity: 1;
    transform: translateY(0);
    pointer-events: all;
  }

  #loginScreen.hide {
    opacity: 0;
    transform: scale(0.97);
    pointer-events: none;
  }

  .login-card {
    background: white;
    border-radius: 28px;
    padding: 44px 40px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.08);
    position: relative;
    overflow: hidden;
    margin: 20px;
  }

  .card-accent {
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 5px;
    background: linear-gradient(90deg, var(--orange), var(--green), var(--blue));
  }

  .card-logo {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 28px;
  }

  .mini-coin {
    width: 38px; height: 38px; border-radius: 50%;
    background: linear-gradient(135deg, var(--orange), #f7931e);
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    box-shadow: 0 4px 12px rgba(255,107,53,0.3);
    flex-shrink: 0;
  }

  .mini-name {
    font-family: 'Nunito', sans-serif;
    font-size: 22px; font-weight: 900; color: var(--text);
    letter-spacing: -0.5px;
  }
  .mini-name span { color: var(--orange); }

  .lang-toggle {
    display: flex; background: var(--cream);
    border-radius: 12px; padding: 4px;
    margin-bottom: 24px; width: fit-content; gap: 2px;
  }

  .lang-btn {
    padding: 6px 16px; border: none; background: transparent;
    border-radius: 9px; font-family: 'Nunito', sans-serif;
    font-size: 13px; font-weight: 700; color: var(--muted);
    cursor: pointer; transition: all 0.2s; letter-spacing: 0.5px;
  }
  .lang-btn.active { background: white; color: var(--orange); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

  .welcome-block { margin-bottom: 28px; }
  .welcome-title { font-family: 'Nunito', sans-serif; font-size: 26px; font-weight: 900; color: var(--text); line-height: 1.2; margin-bottom: 6px; }
  .welcome-sub { font-size: 13px; color: var(--muted); }

  .member-label { font-size: 12px; font-weight: 600; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 10px; }

  .members-row { display: flex; gap: 10px; margin-bottom: 24px; }

  .member-btn {
    flex: 1; padding: 14px 8px;
    border: 2px solid var(--border); background: white;
    border-radius: 16px; cursor: pointer;
    transition: all 0.2s;
    display: flex; flex-direction: column; align-items: center; gap: 6px;
  }
  .member-btn:hover { border-color: var(--orange); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,107,53,0.12); }
  .member-btn.selected { border-color: var(--orange); background: var(--orange-light); }
  .member-avatar { font-size: 26px; line-height: 1; }
  .member-name { font-family: 'Nunito', sans-serif; font-size: 12px; font-weight: 700; color: var(--text); }

  .pin-label { font-size: 12px; font-weight: 600; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 10px; }

  .pin-row { display: flex; gap: 10px; margin-bottom: 28px; justify-content: center; }

  .pin-dot {
    width: 52px; height: 56px;
    border: 2px solid var(--border); border-radius: 14px;
    font-family: 'Nunito', sans-serif; font-size: 24px; font-weight: 900;
    color: var(--text); text-align: center; background: white;
    transition: all 0.2s; outline: none;
    -webkit-text-security: disc;
  }
  .pin-dot:focus { border-color: var(--orange); box-shadow: 0 0 0 4px rgba(255,107,53,0.1); }

  .enter-btn {
    width: 100%; padding: 16px;
    background: linear-gradient(135deg, var(--orange), #f7931e);
    border: none; border-radius: 16px;
    font-family: 'Nunito', sans-serif; font-size: 16px; font-weight: 900;
    color: white; cursor: pointer; letter-spacing: 0.5px;
    box-shadow: 0 8px 24px rgba(255,107,53,0.35);
    transition: all 0.2s;
  }
  .enter-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(255,107,53,0.45); }

  .success-overlay {
    position: absolute; inset: 0;
    background: linear-gradient(135deg, var(--orange), var(--green));
    border-radius: 28px;
    display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px;
    opacity: 0; pointer-events: none; transition: opacity 0.4s;
  }
  .success-overlay.show { opacity: 1; pointer-events: all; }
  .success-icon { font-size: 56px; animation: popBig 0.5s cubic-bezier(0.34,1.56,0.64,1); }
  .success-text { font-family: 'Nunito', sans-serif; font-size: 22px; font-weight: 900; color: white; }
  @keyframes popBig { from { transform: scale(0); } to { transform: scale(1); } }

  @keyframes shake {
    0%,100% { transform: translateX(0); }
    20% { transform: translateX(-8px); }
    40% { transform: translateX(8px); }
    60% { transform: translateX(-6px); }
    80% { transform: translateX(6px); }
  }
  .shake { animation: shake 0.4s ease; }

  /* â”€â”€ CHANGE PIN SCREEN â”€â”€ */
  #changePinScreen {
    position: fixed; inset: 0;
    display: flex; align-items: center; justify-content: center;
    z-index: 950; background: var(--cream);
    opacity: 0; transform: translateY(20px);
    transition: opacity 0.5s ease, transform 0.5s ease;
    pointer-events: none;
  }
  #changePinScreen.show { opacity: 1; transform: translateY(0); pointer-events: all; }
  #changePinScreen.hide { opacity: 0; transform: scale(0.97); pointer-events: none; }

  .change-pin-card {
    background: white; border-radius: 28px;
    padding: 44px 40px; width: 100%; max-width: 400px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.08);
    position: relative; overflow: hidden; margin: 20px;
  }

  .security-icon {
    width: 64px; height: 64px; border-radius: 20px;
    background: linear-gradient(135deg, var(--orange), #f7931e);
    display: flex; align-items: center; justify-content: center;
    font-size: 30px; margin-bottom: 20px;
    box-shadow: 0 8px 24px rgba(255,107,53,0.3);
  }

  .change-pin-title { font-family: 'Nunito', sans-serif; font-size: 24px; font-weight: 900; color: var(--text); margin-bottom: 8px; }
  .change-pin-sub { font-size: 13px; color: var(--muted); margin-bottom: 28px; line-height: 1.5; }

  .pin-step { margin-bottom: 20px; }
  .pin-step-label { font-size: 12px; font-weight: 600; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 10px; }

  .new-pin-row { display: flex; gap: 10px; margin-bottom: 6px; justify-content: center; }

  .new-pin-dot {
    width: 52px; height: 56px;
    border: 2px solid var(--border); border-radius: 14px;
    font-family: 'Nunito', sans-serif; font-size: 24px; font-weight: 900;
    color: var(--text); text-align: center; background: white;
    transition: all 0.2s; outline: none;
    -webkit-text-security: disc;
  }
  .new-pin-dot:focus { border-color: var(--green); box-shadow: 0 0 0 4px rgba(62,207,142,0.1); }

  .pin-match-msg { font-size: 12px; text-align: center; margin-top: 4px; min-height: 16px; }
  .pin-match-msg.ok  { color: var(--green); }
  .pin-match-msg.err { color: var(--red); }

  .save-pin-btn {
    width: 100%; padding: 16px;
    background: linear-gradient(135deg, var(--green), #2db87a);
    border: none; border-radius: 16px;
    font-family: 'Nunito', sans-serif; font-size: 16px; font-weight: 900;
    color: white; cursor: pointer;
    box-shadow: 0 8px 24px rgba(62,207,142,0.35);
    transition: all 0.2s; margin-top: 8px;
  }
  .save-pin-btn:hover { transform: translateY(-2px); }
  .save-pin-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DASHBOARD
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #dashboard {
    display: none;
    padding-bottom: 80px;
    opacity: 0;
    transition: opacity 0.5s ease;
  }
  #dashboard.show { display: block; opacity: 1; }

  .header {
    background: white; padding: 16px 20px;
    display: flex; align-items: center; justify-content: space-between;
    box-shadow: 0 2px 12px rgba(0,0,0,0.05);
    position: sticky; top: 0; z-index: 50;
  }

  .header-logo { display: flex; align-items: center; gap: 8px; }

  .header-coin {
    width: 32px; height: 32px; border-radius: 50%;
    background: linear-gradient(135deg, var(--orange), #f7931e);
    display: flex; align-items: center; justify-content: center;
    font-size: 15px; box-shadow: 0 3px 10px rgba(255,107,53,0.3);
  }

  .header-name { font-family: 'Nunito', sans-serif; font-size: 18px; font-weight: 900; color: var(--text); letter-spacing: -0.5px; }
  .header-name span { color: var(--orange); }

  .header-user {
    display: flex; align-items: center; gap: 8px;
    background: var(--cream); padding: 6px 12px 6px 8px;
    border-radius: 50px; cursor: pointer; transition: background 0.2s;
  }
  .header-user:hover { background: var(--border); }
  .header-avatar { font-size: 20px; }
  .header-username { font-family: 'Nunito', sans-serif; font-size: 13px; font-weight: 700; color: var(--text); }

  .main { max-width: 480px; margin: 0 auto; padding: 20px 16px; }

  .balance-card {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border-radius: 24px; padding: 24px; margin-bottom: 20px;
    position: relative; overflow: hidden;
    box-shadow: 0 12px 40px rgba(26,26,46,0.25);
  }
  .balance-card::before {
    content: ''; position: absolute;
    width: 200px; height: 200px; background: var(--orange);
    border-radius: 50%; opacity: 0.08; top: -60px; right: -60px;
  }
  .balance-card::after {
    content: ''; position: absolute;
    width: 150px; height: 150px; background: var(--green);
    border-radius: 50%; opacity: 0.06; bottom: -50px; left: -30px;
  }

  .balance-label { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.4); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; }
  .balance-month { font-family: 'Nunito', sans-serif; font-size: 13px; font-weight: 700; color: rgba(255,255,255,0.5); margin-bottom: 4px; }
  .balance-amount { font-family: 'Nunito', sans-serif; font-size: 44px; font-weight: 900; color: white; letter-spacing: -2px; margin-bottom: 20px; position: relative; z-index: 1; }

  .balance-members { display: flex; gap: 10px; position: relative; z-index: 1; }

  .balance-member {
    flex: 1; background: rgba(255,255,255,0.07);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 14px; padding: 10px 12px;
  }
  .bm-name { font-size: 11px; color: rgba(255,255,255,0.5); font-weight: 600; margin-bottom: 2px; }
  .bm-amount { font-family: 'Nunito', sans-serif; font-size: 16px; font-weight: 900; color: white; }
  .bm-amount.positive { color: var(--green); }
  .bm-amount.negative { color: #ff8a80; }
  .bm-status { font-size: 10px; color: rgba(255,255,255,0.35); margin-top: 1px; }

  /* â”€â”€ DEBT SUMMARY SECTION â”€â”€ */
  .debt-section { margin-bottom: 24px; }

  .debt-card {
    background: white; border-radius: 18px;
    padding: 14px 16px; margin-bottom: 8px;
    display: flex; align-items: center; gap: 14px;
    box-shadow: var(--card-shadow);
    animation: slideIn 0.3s ease;
  }

  .debt-card.settled {
    background: var(--green-light);
    border: 1px solid rgba(62,207,142,0.2);
  }

  .debt-avatar-row { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
  .debt-av { font-size: 26px; line-height: 1; }
  .debt-arrow { font-size: 14px; color: var(--muted); }

  .debt-info { flex: 1; }
  .debt-text { font-family: 'Nunito', sans-serif; font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 2px; }
  .debt-text strong { color: var(--orange); }
  .debt-text.ok strong { color: var(--green); }
  .debt-sub { font-size: 11px; color: var(--muted); }

  .debt-amount { font-family: 'Nunito', sans-serif; font-size: 18px; font-weight: 900; color: var(--orange); flex-shrink: 0; }
  .debt-amount.ok { color: var(--green); font-size: 14px; }

  .settle-quick-btn {
    background: var(--orange); border: none; border-radius: 10px;
    padding: 6px 12px; color: white; font-family: 'Nunito', sans-serif;
    font-size: 11px; font-weight: 700; cursor: pointer;
    transition: all 0.2s; flex-shrink: 0;
  }
  .settle-quick-btn:hover { background: #e55a25; transform: scale(1.05); }

  /* Detail modal */
  .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .detail-row:last-child { border-bottom: none; }
  .detail-label { font-size: 13px; color: var(--text2); }
  .detail-label span { font-size: 16px; margin-right: 6px; }
  .detail-value { font-family: 'Nunito', sans-serif; font-size: 14px; font-weight: 700; color: var(--text); }
  .detail-value.pos { color: var(--green); }
  .detail-value.neg { color: var(--red); }

  .section-title { font-family: 'Nunito', sans-serif; font-size: 14px; font-weight: 700; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 12px; }

  .quick-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 24px; }

  .qa-btn {
    background: white; border: none; border-radius: 18px; padding: 16px;
    cursor: pointer; display: flex; align-items: center; gap: 12px;
    box-shadow: var(--card-shadow); transition: all 0.2s; text-align: left;
  }
  .qa-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(0,0,0,0.1); }

  .qa-icon { width: 44px; height: 44px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
  .qa-icon.orange { background: var(--orange-light); }
  .qa-icon.green  { background: var(--green-light); }
  .qa-icon.blue   { background: var(--blue-light); }
  .qa-icon.red    { background: var(--red-light); }

  .qa-label { font-family: 'Nunito', sans-serif; font-size: 13px; font-weight: 700; color: var(--text); line-height: 1.3; }

  .expenses-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .see-all { font-size: 12px; font-weight: 600; color: var(--orange); background: none; border: none; cursor: pointer; font-family: 'Nunito', sans-serif; }

  .expense-item {
    background: white; border-radius: 18px; padding: 14px 16px;
    margin-bottom: 8px; display: flex; align-items: center; gap: 14px;
    box-shadow: var(--card-shadow); transition: all 0.2s; cursor: pointer;
    animation: slideIn 0.3s ease;
  }
  @keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
  .expense-item:hover { transform: translateX(4px); }

  .expense-emoji { width: 46px; height: 46px; border-radius: 14px; background: var(--cream); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; }
  .expense-info { flex: 1; min-width: 0; }
  .expense-desc { font-family: 'Nunito', sans-serif; font-size: 14px; font-weight: 700; color: var(--text); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .expense-meta { font-size: 12px; color: var(--muted); display: flex; gap: 6px; align-items: center; }
  .expense-who { background: var(--cream); padding: 2px 7px; border-radius: 6px; font-weight: 600; color: var(--text2); font-size: 11px; }
  .expense-amount { font-family: 'Nunito', sans-serif; font-size: 16px; font-weight: 900; color: var(--text); flex-shrink: 0; }
  .expense-split { font-size: 11px; color: var(--muted); text-align: right; margin-top: 2px; }
  .expense-split.green { color: var(--green); }

  .empty-state { text-align: center; padding: 40px 20px; color: var(--muted); }
  .empty-state .empty-icon { font-size: 48px; margin-bottom: 10px; }
  .empty-state p { font-size: 14px; font-weight: 600; }

  .bottom-nav {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: white;
    padding: 10px 20px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    display: flex; justify-content: space-around;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.06); z-index: 50;
  }

  .nav-item { display: flex; flex-direction: column; align-items: center; gap: 3px; cursor: pointer; padding: 6px 16px; border-radius: 14px; transition: all 0.2s; border: none; background: none; }
  .nav-item.active { background: var(--orange-light); }
  .nav-item .nav-icon { font-size: 22px; }
  .nav-item .nav-label { font-family: 'Nunito', sans-serif; font-size: 10px; font-weight: 700; color: var(--muted); letter-spacing: 0.5px; }
  .nav-item.active .nav-label { color: var(--orange); }

  .fab {
    position: fixed; bottom: 72px; right: 20px;
    width: 58px; height: 58px; border-radius: 50%;
    background: linear-gradient(135deg, var(--orange), #f7931e);
    border: none; color: white; font-size: 28px; cursor: pointer;
    box-shadow: 0 8px 24px rgba(255,107,53,0.45);
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; z-index: 60;
  }
  .fab:hover { transform: scale(1.1) rotate(90deg); }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(26,26,46,0.5);
    z-index: 200; display: flex; align-items: flex-end; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.show { opacity: 1; pointer-events: all; }

  .modal {
    background: white; border-radius: 28px 28px 0 0;
    padding: 28px 24px 40px; width: 100%; max-width: 480px;
    transform: translateY(100%);
    transition: transform 0.4s cubic-bezier(0.34,1.1,0.64,1);
    max-height: 90vh; overflow-y: auto;
  }
  .modal-overlay.show .modal { transform: translateY(0); }

  .modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 4px; margin: 0 auto 20px; }
  .modal-title { font-family: 'Nunito', sans-serif; font-size: 22px; font-weight: 900; color: var(--text); margin-bottom: 22px; }

  .form-group { margin-bottom: 18px; }
  .form-label { font-size: 12px; font-weight: 600; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 8px; display: block; }
  .form-input { width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: 14px; font-family: 'Nunito', sans-serif; font-size: 16px; font-weight: 700; color: var(--text); background: white; outline: none; transition: border-color 0.2s; }
  .form-input:focus { border-color: var(--orange); box-shadow: 0 0 0 4px rgba(255,107,53,0.08); }
  .amount-input { font-size: 32px; font-weight: 900; text-align: center; letter-spacing: -1px; color: var(--orange); }

  .cat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
  .cat-pill { padding: 10px 6px; border: 2px solid var(--border); border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.15s; }
  .cat-pill:hover, .cat-pill.selected { border-color: var(--orange); background: var(--orange-light); }
  .cat-pill .cat-emoji { font-size: 22px; }
  .cat-pill .cat-name { font-size: 10px; font-weight: 700; color: var(--text2); }

  .paid-grid { display: flex; gap: 8px; }
  .paid-btn { flex: 1; padding: 12px 8px; border: 2px solid var(--border); border-radius: 14px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.15s; }
  .paid-btn:hover, .paid-btn.selected { border-color: var(--blue); background: var(--blue-light); }
  .paid-btn .paid-avatar { font-size: 24px; }
  .paid-btn .paid-name { font-size: 12px; font-weight: 700; color: var(--text); }

  .split-grid { display: flex; gap: 8px; }
  .split-btn { flex: 1; padding: 10px; border: 2px solid var(--border); border-radius: 12px; background: white; cursor: pointer; font-size: 11px; font-weight: 700; color: var(--text2); font-family: 'Nunito', sans-serif; transition: all 0.15s; display: flex; flex-direction: column; align-items: center; gap: 2px; }
  .split-btn .split-emoji { font-size: 18px; }
  .split-btn:hover, .split-btn.selected { border-color: var(--green); background: var(--green-light); color: #1a7a52; }

  .submit-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--orange), #f7931e); border: none; border-radius: 16px; font-family: 'Nunito', sans-serif; font-size: 16px; font-weight: 900; color: white; cursor: pointer; box-shadow: 0 8px 24px rgba(255,107,53,0.35); transition: all 0.2s; margin-top: 8px; }
  .submit-btn:hover { transform: translateY(-2px); }
  .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); display: inline-block; margin-right: 4px; animation: pulse 2s infinite; }
  .sync-dot.offline { background: var(--muted); animation: none; }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }
  .sync-label { font-size: 11px; color: var(--muted); display: flex; align-items: center; margin-bottom: 16px; }

  .skeleton { background: linear-gradient(90deg, #f0ece7 25%, #e8e4df 50%, #f0ece7 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 18px; height: 70px; margin-bottom: 8px; }
  @keyframes shimmer { from { background-position: 200% 0; } to { background-position: -200% 0; } }

  /* â”€â”€ STATS â”€â”€ */
  .member-bar-row { margin-bottom: 14px; }
  .member-bar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
  .member-bar-name { font-family: 'Nunito', sans-serif; font-size: 13px; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 6px; }
  .member-bar-amt  { font-family: 'Nunito', sans-serif; font-size: 14px; font-weight: 900; color: var(--text); }
  .member-bar-pct  { font-size: 11px; color: var(--muted); }
  .bar-track { background: var(--border); border-radius: 50px; height: 12px; overflow: hidden; }
  .bar-fill  { height: 100%; border-radius: 50px; transition: width 0.8s cubic-bezier(0.34,1.2,0.64,1); width: 0; }
  .bar-fill.diego  { background: linear-gradient(90deg, var(--orange), #f7931e); }
  .bar-fill.leo    { background: linear-gradient(90deg, var(--blue), #60a5fa); }
  .bar-fill.julian { background: linear-gradient(90deg, var(--green), #34d399); }
  .bar-fill.cat    { background: linear-gradient(90deg, #a78bfa, #818cf8); }

  .cat-bar-row { margin-bottom: 10px; }
  .cat-bar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
  .cat-bar-name { font-size: 12px; color: var(--text2); display: flex; align-items: center; gap: 6px; }
  .cat-bar-amt  { font-family: 'Nunito', sans-serif; font-size: 12px; font-weight: 700; color: var(--text); }

  .top-expense-row { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .top-expense-row:last-child { border-bottom: none; }
  .top-rank { font-family: 'Nunito', sans-serif; font-size: 18px; font-weight: 900; color: var(--border); width: 24px; text-align: center; flex-shrink: 0; }
  .top-rank.gold   { color: #f59e0b; }
  .top-rank.silver { color: #94a3b8; }
  .top-rank.bronze { color: #b45309; }
  .top-info { flex: 1; }
  .top-desc { font-family: 'Nunito', sans-serif; font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
  .top-meta { font-size: 11px; color: var(--muted); }
  .top-amt  { font-family: 'Nunito', sans-serif; font-size: 15px; font-weight: 900; color: var(--text); flex-shrink: 0; } top: 80px; left: 50%; transform: translateX(-50%) translateY(-20px); background: var(--text); color: white; padding: 12px 20px; border-radius: 50px; font-family: 'Nunito', sans-serif; font-size: 13px; font-weight: 700; opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 999; white-space: nowrap; }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SPLASH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="splash">
  <div class="coin-wrapper">
    <div class="coin">ğŸ’°</div>
    <div class="split-line"></div>
    <div class="split-line"></div>
    <div class="split-line"></div>
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
  </div>
  <div class="splash-text">
    <div class="spent-l">
      <span class="letter">S</span><span class="letter">p</span><span class="letter">e</span><span class="letter">n</span><span class="letter">t</span>
    </div>
    <div class="share-l">
      <span class="letter">S</span><span class="letter">h</span><span class="letter">a</span><span class="letter">r</span><span class="letter">e</span>
    </div>
  </div>
  <div class="splash-tagline" id="splashTagline">Family expenses made easy</div>
  <div class="splash-loader"><div class="splash-loader-bar"></div></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loginScreen">
  <div class="login-card" id="loginCard">
    <div class="card-accent"></div>
    <div class="card-logo">
      <div class="mini-coin">ğŸ’°</div>
      <div class="mini-name">Spent<span>Share</span></div>
    </div>
    <div class="lang-toggle">
      <button class="lang-btn" onclick="setLang('en')" id="btnEn">EN</button>
      <button class="lang-btn active" onclick="setLang('es')" id="btnEs">ES</button>
    </div>
    <div class="welcome-block">
      <div class="welcome-title" id="welcomeTitle">Â¡Bienvenido! ğŸ‘‹</div>
      <div class="welcome-sub" id="welcomeSub">Â¿QuiÃ©n estÃ¡ usando la app?</div>
    </div>
    <div class="member-label" id="memberLabel">SELECCIONA TU PERFIL</div>
    <div class="members-row">
      <button class="member-btn selected" onclick="selectMember(this,'diego')" data-pin="1234">
        <div class="member-avatar">ğŸ‘¨</div>
        <div class="member-name" id="name-diego">Diego</div>
      </button>
      <button class="member-btn" onclick="selectMember(this,'leo')" data-pin="5678">
        <div class="member-avatar">ğŸ‘¨</div>
        <div class="member-name" id="name-leo">Leo</div>
      </button>
      <button class="member-btn" onclick="selectMember(this,'julian')" data-pin="0000">
        <div class="member-avatar">ğŸ§’</div>
        <div class="member-name" id="name-julian">Julian</div>
      </button>
    </div>
    <div class="pin-label" id="pinLabel">INGRESA TU PIN</div>
    <div class="pin-row">
      <input class="pin-dot" type="password" maxlength="1" inputmode="numeric" id="p1" oninput="moveFocus(this,null,'p2')">
      <input class="pin-dot" type="password" maxlength="1" inputmode="numeric" id="p2" oninput="moveFocus(this,'p1','p3')">
      <input class="pin-dot" type="password" maxlength="1" inputmode="numeric" id="p3" oninput="moveFocus(this,'p2','p4')">
      <input class="pin-dot" type="password" maxlength="1" inputmode="numeric" id="p4" oninput="moveFocus(this,'p3',null)">
    </div>
    <button class="enter-btn" onclick="doLogin()"><span id="enterBtnText">Entrar â†’</span></button>
    <div class="success-overlay" id="successOverlay">
      <div class="success-icon">âœ…</div>
      <div class="success-text" id="successText">Â¡Bienvenido!</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CHANGE PIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="changePinScreen">
  <div class="change-pin-card" id="changePinCard">
    <div class="card-accent"></div>
    <div class="security-icon">ğŸ”</div>
    <div class="change-pin-title">Crea tu PIN</div>
    <div class="change-pin-sub">Es tu primera vez, <strong id="changePinUser">Diego</strong>. Por seguridad, crea un PIN personal de 4 dÃ­gitos.</div>
    <div class="pin-step">
      <div class="pin-step-label">Nuevo PIN</div>
      <div class="new-pin-row">
        <input class="new-pin-dot" type="password" maxlength="1" inputmode="numeric" id="np1" oninput="moveNewFocus(this,null,'np2')">
        <input class="new-pin-dot" type="password" maxlength="1" inputmode="numeric" id="np2" oninput="moveNewFocus(this,'np1','np3')">
        <input class="new-pin-dot" type="password" maxlength="1" inputmode="numeric" id="np3" oninput="moveNewFocus(this,'np2','np4')">
        <input class="new-pin-dot" type="password" maxlength="1" inputmode="numeric" id="np4" oninput="moveNewFocus(this,'np3','nc1'); checkPinMatch()">
      </div>
    </div>
    <div class="pin-step">
      <div class="pin-step-label">Confirma tu PIN</div>
      <div class="new-pin-row">
        <input class="new-pin-dot" type="password" maxlength="1" inputmode="numeric" id="nc1" oninput="moveNewFocus(this,null,'nc2'); checkPinMatch()">
        <input class="new-pin-dot" type="password" maxlength="1" inputmode="numeric" id="nc2" oninput="moveNewFocus(this,'nc1','nc3'); checkPinMatch()">
        <input class="new-pin-dot" type="password" maxlength="1" inputmode="numeric" id="nc3" oninput="moveNewFocus(this,'nc2','nc4'); checkPinMatch()">
        <input class="new-pin-dot" type="password" maxlength="1" inputmode="numeric" id="nc4" oninput="moveNewFocus(this,'nc3',null); checkPinMatch()">
      </div>
      <div class="pin-match-msg" id="pinMatchMsg"></div>
    </div>
    <button class="save-pin-btn" id="savePinBtn" onclick="saveNewPin()" disabled>Guardar PIN âœ“</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="dashboard">
  <div class="header">
    <div class="header-logo">
      <div class="header-coin">ğŸ’°</div>
      <div class="header-name">Spent<span>Share</span></div>
    </div>
    <div class="header-user" onclick="logoutUser()">
      <div class="header-avatar" id="headerAvatar">ğŸ‘¨</div>
      <div class="header-username" id="headerUsername">Diego</div>
    </div>
  </div>

  <div class="main">
    <div class="sync-label">
      <span class="sync-dot" id="syncDot"></span>
      <span id="syncLabel">Conectando...</span>
    </div>

    <div class="balance-card">
      <div class="balance-label">Gastos del mes</div>
      <div class="balance-month" id="balanceMonth">Febrero 2026</div>
      <div class="balance-amount" id="totalMonth">$0.00</div>
      <div class="balance-members">
        <div class="balance-member">
          <div class="bm-name">Diego</div>
          <div class="bm-amount" id="bal-diego">$0.00</div>
          <div class="bm-status" id="balst-diego">â€”</div>
        </div>
        <div class="balance-member">
          <div class="bm-name">Leo</div>
          <div class="bm-amount" id="bal-leo">$0.00</div>
          <div class="bm-status" id="balst-leo">â€”</div>
        </div>
        <div class="balance-member">
          <div class="bm-name">Julian</div>
          <div class="bm-amount" id="bal-julian">$0.00</div>
          <div class="bm-status" id="balst-julian">â€”</div>
        </div>
      </div>
    </div>

    <div class="section-title">Acciones rÃ¡pidas</div>
    <div class="quick-actions">
      <button class="qa-btn" onclick="openModal()">
        <div class="qa-icon orange">â•</div>
        <div class="qa-label">Agregar gasto</div>
      </button>
      <button class="qa-btn" onclick="openSettleModal()">
        <div class="qa-icon green">ğŸ¤</div>
        <div class="qa-label">Liquidar deuda</div>
      </button>
      <button class="qa-btn" onclick="openDebtDetail()">
        <div class="qa-icon blue">ğŸ’°</div>
        <div class="qa-label">Ver balances</div>
      </button>
      <button class="qa-btn" onclick="openStatsModal()">
        <div class="qa-icon red">ğŸ“ˆ</div>
        <div class="qa-label">EstadÃ­sticas</div>
      </button>
    </div>

    <!-- DEBT SUMMARY -->
    <div class="debt-section">
      <div class="expenses-header">
        <div class="section-title" style="margin:0">ğŸ’¸ QuiÃ©n le debe a quiÃ©n</div>
        <button class="see-all" onclick="openDebtDetail()">Detalle â†’</button>
      </div>
      <div id="debtSummary"></div>
    </div>

    <div class="expenses-header">
      <div class="section-title" style="margin:0">Gastos recientes</div>
      <button class="see-all" onclick="showToast('Ver todos â€” prÃ³ximamente')">Ver todos â†’</button>
    </div>

    <div id="loadingSkeletons">
      <div class="skeleton"></div>
      <div class="skeleton"></div>
      <div class="skeleton"></div>
    </div>
    <div id="expensesList"></div>
  </div>

  <button class="fab" onclick="openModal()">+</button>

  <div class="bottom-nav">
    <button class="nav-item active" onclick="setTab(this)">
      <span class="nav-icon">ğŸ </span><span class="nav-label">Inicio</span>
    </button>
    <button class="nav-item" onclick="setTab(this)">
      <span class="nav-icon">ğŸ“‹</span><span class="nav-label">Historial</span>
    </button>
    <button class="nav-item" onclick="setTab(this)">
      <span class="nav-icon">ğŸ“Š</span><span class="nav-label">Stats</span>
    </button>
    <button class="nav-item" onclick="setTab(this); logoutUser()">
      <span class="nav-icon">ğŸšª</span><span class="nav-label">Salir</span>
    </button>
  </div>
</div>

<!-- STATS MODAL -->
<div class="modal-overlay" id="statsModal" onclick="closeOnOverlay(event,'statsModal')">
  <div class="modal" style="padding-bottom:50px">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ“ˆ EstadÃ­sticas â€” <span id="statsMonthLabel" style="color:var(--orange)"></span></div>

    <!-- Total highlight -->
    <div id="statsTotalCard" style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:18px;padding:16px 20px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-size:11px;color:rgba(255,255,255,0.4);letter-spacing:2px;text-transform:uppercase;margin-bottom:4px">Total del mes</div>
        <div id="statsTotalAmt" style="font-family:'Nunito',sans-serif;font-size:32px;font-weight:900;color:white;letter-spacing:-1px">$0.00</div>
      </div>
      <div style="font-size:40px">ğŸ’°</div>
    </div>

    <!-- Bar chart: comparison between members -->
    <div class="section-title" style="margin-bottom:14px">ComparaciÃ³n entre miembros</div>
    <div id="memberBars" style="margin-bottom:24px"></div>

    <!-- Category breakdown -->
    <div class="section-title" style="margin-bottom:14px">Por categorÃ­a</div>
    <div id="categoryBars" style="margin-bottom:24px"></div>

    <!-- Top expenses -->
    <div class="section-title" style="margin-bottom:14px">Top gastos del mes</div>
    <div id="topExpenses"></div>
  </div>
</div>

<!-- DEBT DETAIL MODAL -->
<div class="modal-overlay" id="debtModal" onclick="closeOnOverlay(event,'debtModal')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ’° Detalle de balances</div>
    <div id="debtDetailContent"></div>
  </div>
</div>

<!-- ADD EXPENSE MODAL -->
<div class="modal-overlay" id="addModal" onclick="closeOnOverlay(event,'addModal')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ’¸ Nuevo gasto</div>
    <div class="form-group">
      <label class="form-label">Monto</label>
      <input class="form-input amount-input" type="number" id="inputAmount" placeholder="$0.00" min="0" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">DescripciÃ³n</label>
      <input class="form-input" type="text" id="inputDesc" placeholder="ej. Despensa, gasolina...">
    </div>
    <div class="form-group">
      <label class="form-label">CategorÃ­a</label>
      <div class="cat-grid">
        <button class="cat-pill selected" data-cat="food" onclick="selectCat(this)"><span class="cat-emoji">ğŸ›’</span><span class="cat-name">Comida</span></button>
        <button class="cat-pill" data-cat="transport" onclick="selectCat(this)"><span class="cat-emoji">ğŸš—</span><span class="cat-name">Transporte</span></button>
        <button class="cat-pill" data-cat="utilities" onclick="selectCat(this)"><span class="cat-emoji">ğŸ’¡</span><span class="cat-name">Servicios</span></button>
        <button class="cat-pill" data-cat="health" onclick="selectCat(this)"><span class="cat-emoji">ğŸ’Š</span><span class="cat-name">Salud</span></button>
        <button class="cat-pill" data-cat="entertainment" onclick="selectCat(this)"><span class="cat-emoji">ğŸ¬</span><span class="cat-name">Ocio</span></button>
        <button class="cat-pill" data-cat="home" onclick="selectCat(this)"><span class="cat-emoji">ğŸ </span><span class="cat-name">Casa</span></button>
        <button class="cat-pill" data-cat="education" onclick="selectCat(this)"><span class="cat-emoji">ğŸ“š</span><span class="cat-name">EducaciÃ³n</span></button>
        <button class="cat-pill" data-cat="other" onclick="selectCat(this)"><span class="cat-emoji">ğŸ“¦</span><span class="cat-name">Otro</span></button>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Â¿QuiÃ©n pagÃ³?</label>
      <div class="paid-grid">
        <button class="paid-btn" data-member="Diego" onclick="selectPaidBy(this)"><span class="paid-avatar">ğŸ‘¨</span><span class="paid-name">Diego</span></button>
        <button class="paid-btn" data-member="Leo" onclick="selectPaidBy(this)"><span class="paid-avatar">ğŸ‘¨</span><span class="paid-name">Leo</span></button>
        <button class="paid-btn" data-member="Julian" onclick="selectPaidBy(this)"><span class="paid-avatar">ğŸ§’</span><span class="paid-name">Julian</span></button>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Â¿Entre quiÃ©nes se divide?</label>
      <div class="split-grid">
        <button class="split-btn selected" data-split="all" onclick="selectSplit(this)"><span class="split-emoji">ğŸ‘¥</span>Todos</button>
        <button class="split-btn" data-split="two" onclick="selectSplit(this)"><span class="split-emoji">ğŸ‘¤</span>Dos personas</button>
        <button class="split-btn" data-split="solo" onclick="selectSplit(this)"><span class="split-emoji">ğŸ§¾</span>Solo yo</button>
      </div>
    </div>

    <!-- WITH WHOM (solo visible cuando split=two) -->
    <div class="form-group" id="withWhomGroup" style="display:none">
      <label class="form-label">Â¿Con quiÃ©n compartes?</label>
      <div class="paid-grid" id="withWhomGrid">
        <button class="paid-btn" data-member="Diego" onclick="selectWithWhom(this)"><span class="paid-avatar">ğŸ‘¨</span><span class="paid-name">Diego</span></button>
        <button class="paid-btn" data-member="Leo" onclick="selectWithWhom(this)"><span class="paid-avatar">ğŸ‘¨</span><span class="paid-name">Leo</span></button>
        <button class="paid-btn" data-member="Julian" onclick="selectWithWhom(this)"><span class="paid-avatar">ğŸ§’</span><span class="paid-name">Julian</span></button>
      </div>
    </div>
    <button class="submit-btn" id="submitBtn" onclick="addExpense()">Agregar gasto âœ“</button>
  </div>
</div>

<!-- SETTLE MODAL -->
<div class="modal-overlay" id="settleModal" onclick="closeOnOverlay(event,'settleModal')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ¤ Liquidar deuda</div>
    <div class="form-group">
      <label class="form-label">Â¿QuiÃ©n paga?</label>
      <div class="paid-grid" id="settleFromGrid">
        <button class="paid-btn" data-member="Diego" onclick="selectSettleFrom(this)"><span class="paid-avatar">ğŸ‘¨</span><span class="paid-name">Diego</span></button>
        <button class="paid-btn" data-member="Leo" onclick="selectSettleFrom(this)"><span class="paid-avatar">ğŸ‘¨</span><span class="paid-name">Leo</span></button>
        <button class="paid-btn" data-member="Julian" onclick="selectSettleFrom(this)"><span class="paid-avatar">ğŸ§’</span><span class="paid-name">Julian</span></button>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Â¿A quiÃ©n le paga?</label>
      <div class="paid-grid" id="settleToGrid">
        <button class="paid-btn" data-member="Diego" onclick="selectSettleTo(this)"><span class="paid-avatar">ğŸ‘¨</span><span class="paid-name">Diego</span></button>
        <button class="paid-btn" data-member="Leo" onclick="selectSettleTo(this)"><span class="paid-avatar">ğŸ‘¨</span><span class="paid-name">Leo</span></button>
        <button class="paid-btn" data-member="Julian" onclick="selectSettleTo(this)"><span class="paid-avatar">ğŸ§’</span><span class="paid-name">Julian</span></button>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Monto</label>
      <input class="form-input amount-input" type="number" id="settleAmount" placeholder="$0.00" min="0" step="0.01">
    </div>
    <button class="submit-btn" onclick="addSettle()">Registrar pago âœ“</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, deleteDoc, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyB-KQnjwvoRvUciDDFR5eHOjwGZbh8DBZI",
    authDomain: "spendshare-ed3fa.firebaseapp.com",
    projectId: "spendshare-ed3fa",
    storageBucket: "spendshare-ed3fa.firebasestorage.app",
    messagingSenderId: "142707923361",
    appId: "1:142707923361:web:55b965b821dfa336b413e0"
  });

  const db = getFirestore(app);
  window._db = db;
  window._addDoc = addDoc;
  window._collection = collection;
  window._serverTimestamp = serverTimestamp;
  window._deleteDoc = deleteDoc;
  window._doc = doc;
  window._getDocs = getDocs;
  window._setDoc = setDoc;
  window._docRef = doc;

  const q = query(collection(db, 'expenses'), orderBy('createdAt', 'desc'));
  onSnapshot(q, (snapshot) => {
    document.getElementById('syncDot').classList.remove('offline');
    document.getElementById('syncLabel').textContent = 'Sincronizado âœ“';
    const expenses = [];
    snapshot.forEach(d => expenses.push({ id: d.id, ...d.data() }));
    window._expenses = expenses;
    renderExpenses(expenses);
    updateBalances(expenses);
    document.getElementById('loadingSkeletons').style.display = 'none';
  }, () => {
    document.getElementById('syncDot').classList.add('offline');
    document.getElementById('syncLabel').textContent = 'Sin conexiÃ³n';
    document.getElementById('loadingSkeletons').style.display = 'none';
  });
</script>

<script>
  // â”€â”€ State â”€â”€
  let currentUser = 'Diego';
  let currentAvatar = 'ğŸ‘¨';
  let selectedCat = 'food';
  let selectedPaidBy = null;
  let selectedSplit = 'all';
  let settleFrom = null;
  let settleTo = null;
  let lang = 'es';

  const members = ['Diego','Leo','Julian'];
  const avatars = { Diego:'ğŸ‘¨', Leo:'ğŸ‘¨', Julian:'ğŸ§’' };
  const catEmojis = { food:'ğŸ›’', transport:'ğŸš—', utilities:'ğŸ’¡', health:'ğŸ’Š', entertainment:'ğŸ¬', home:'ğŸ ', education:'ğŸ“š', other:'ğŸ“¦' };

  const translations = {
    es: { tagline:'Gastos familiares sin drama', welcomeTitle:'Â¡Bienvenido! ğŸ‘‹', welcomeSub:'Â¿QuiÃ©n estÃ¡ usando la app?', memberLabel:'SELECCIONA TU PERFIL', pinLabel:'INGRESA TU PIN', enterBtn:'Entrar â†’', success:{ diego:'Â¡Bienvenido, Diego! ğŸ‰', leo:'Â¡Bienvenido, Leo! ğŸ‰', julian:'Â¡Bienvenido, Julian! ğŸ‰' } },
    en: { tagline:'Family expenses made easy', welcomeTitle:'Welcome! ğŸ‘‹', welcomeSub:'Who is using the app?', memberLabel:'SELECT YOUR PROFILE', pinLabel:'ENTER YOUR PIN', enterBtn:'Enter â†’', success:{ diego:'Welcome, Diego! ğŸ‰', leo:'Welcome, Leo! ğŸ‰', julian:'Welcome, Julian! ğŸ‰' } }
  };

  // â”€â”€ Language â”€â”€
  function setLang(l) {
    lang = l;
    document.getElementById('btnEn').classList.toggle('active', l==='en');
    document.getElementById('btnEs').classList.toggle('active', l==='es');
    const tx = translations[l];
    document.getElementById('splashTagline').textContent = tx.tagline;
    document.getElementById('welcomeTitle').textContent = tx.welcomeTitle;
    document.getElementById('welcomeSub').textContent = tx.welcomeSub;
    document.getElementById('memberLabel').textContent = tx.memberLabel;
    document.getElementById('pinLabel').textContent = tx.pinLabel;
    document.getElementById('enterBtnText').textContent = tx.enterBtn;
  }

  // â”€â”€ Splash â†’ Login â”€â”€
  setTimeout(() => {
    document.getElementById('splash').classList.add('hide');
    setTimeout(() => {
      document.getElementById('splash').style.display = 'none';
      document.getElementById('loginScreen').classList.add('show');
      setTimeout(() => document.getElementById('p1').focus(), 300);
    }, 700);
  }, 4800);

  // â”€â”€ Member select â”€â”€
  let selectedMemberKey = 'diego';
  function selectMember(el, key) {
    document.querySelectorAll('.member-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    selectedMemberKey = key;
    clearPin();
    document.getElementById('p1').focus();
  }

  // â”€â”€ PIN â”€â”€
  function moveFocus(el, prevId, nextId) {
    if (el.value && nextId) document.getElementById(nextId).focus();
  }

  document.querySelectorAll('.pin-dot').forEach(input => {
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Backspace' && !this.value) {
        const ids = ['p1','p2','p3','p4'];
        const idx = ids.indexOf(this.id);
        if (idx > 0) document.getElementById(ids[idx-1]).focus();
      }
      if (e.key === 'Enter') doLogin();
    });
  });

  function getPin() { return ['p1','p2','p3','p4'].map(id => document.getElementById(id).value).join(''); }
  function clearPin() { ['p1','p2','p3','p4'].forEach(id => document.getElementById(id).value = ''); }

  const defaultPins = { diego:'1234', leo:'5678', julian:'0000' };
  // pins will be loaded from Firestore, fallback to defaults
  let pins = { ...defaultPins };

  // â”€â”€ Load PINs from Firestore â”€â”€
  async function loadPins() {
    try {
      const snap = await window._getDocs(window._collection(window._db, 'pins'));
      snap.forEach(d => { pins[d.id] = d.data().pin; });
    } catch(e) { console.log('Using default pins'); }
  }
  loadPins();

  function getNewPin()     { return ['np1','np2','np3','np4'].map(id=>document.getElementById(id).value).join(''); }
  function getConfirmPin() { return ['nc1','nc2','nc3','nc4'].map(id=>document.getElementById(id).value).join(''); }
  function clearNewPins()  { ['np1','np2','np3','np4','nc1','nc2','nc3','nc4'].forEach(id=>document.getElementById(id).value=''); }

  function moveNewFocus(el, prevId, nextId) {
    if (el.value && nextId) document.getElementById(nextId).focus();
    if (!el.value && prevId) {}
  }

  document.querySelectorAll('.new-pin-dot').forEach(input => {
    input.addEventListener('keydown', function(e) {
      if (e.key==='Backspace' && !this.value) {
        const ids=['np1','np2','np3','np4','nc1','nc2','nc3','nc4'];
        const idx=ids.indexOf(this.id);
        if (idx>0) document.getElementById(ids[idx-1]).focus();
      }
    });
  });

  function checkPinMatch() {
    const np = getNewPin();
    const nc = getConfirmPin();
    const msg = document.getElementById('pinMatchMsg');
    const btn = document.getElementById('savePinBtn');
    if (nc.length < 4) { msg.textContent=''; btn.disabled=true; return; }
    if (np === nc && np.length===4) {
      msg.textContent='âœ“ Los PINs coinciden'; msg.className='pin-match-msg ok';
      btn.disabled=false;
    } else {
      msg.textContent='âœ— Los PINs no coinciden'; msg.className='pin-match-msg err';
      btn.disabled=true;
    }
  }

  async function saveNewPin() {
    const newPin = getNewPin();
    if (newPin.length < 4) return;
    const btn = document.getElementById('savePinBtn');
    btn.disabled=true; btn.textContent='Guardando...';
    try {
      await window._setDoc(window._docRef(window._db,'pins',selectedMemberKey), { pin: newPin });
      pins[selectedMemberKey] = newPin;
      showToast('ğŸ” PIN guardado exitosamente');
      clearNewPins();
      // hide change pin, go to dashboard
      document.getElementById('changePinScreen').classList.add('hide');
      setTimeout(() => {
        document.getElementById('changePinScreen').style.display='none';
        finalizeDashboard();
      }, 500);
    } catch(e) {
      showToast('âŒ Error al guardar PIN');
      btn.disabled=false; btn.textContent='Guardar PIN âœ“';
    }
  }

  function doLogin() {
    const entered = getPin();
    if (entered.length < 4) { shakePins(); return; }
    const correctPin = pins[selectedMemberKey] || defaultPins[selectedMemberKey];
    if (entered === correctPin) {
      const tx = translations[lang];
      document.getElementById('successText').textContent = tx.success[selectedMemberKey];
      document.getElementById('successOverlay').classList.add('show');
      currentUser = selectedMemberKey.charAt(0).toUpperCase() + selectedMemberKey.slice(1);
      currentAvatar = avatars[currentUser];
      // Check if using default PIN
      const isDefault = entered === defaultPins[selectedMemberKey] && !pins[selectedMemberKey + '_changed'];
      if (isDefault) {
        setTimeout(() => showChangePinScreen(), 1500);
      } else {
        setTimeout(() => goToDashboard(), 1500);
      }
    } else {
      shakePins();
      clearPin();
      document.getElementById('p1').focus();
    }
  }

  function showChangePinScreen() {
    document.getElementById('loginScreen').classList.add('hide');
    document.getElementById('changePinUser').textContent = currentUser;
    setTimeout(() => {
      document.getElementById('loginScreen').style.display='none';
      document.getElementById('successOverlay').classList.remove('show');
      const cp = document.getElementById('changePinScreen');
      cp.style.display='flex';
      setTimeout(() => { cp.classList.add('show'); document.getElementById('np1').focus(); }, 50);
    }, 500);
  }

  function shakePins() {
    const card = document.getElementById('loginCard');
    card.classList.remove('shake');
    void card.offsetWidth;
    card.classList.add('shake');
  }

  function goToDashboard() {
    document.getElementById('loginScreen').classList.add('hide');
    document.getElementById('successOverlay').classList.remove('show');
    setTimeout(() => {
      document.getElementById('loginScreen').style.display = 'none';
      finalizeDashboard();
    }, 500);
  }

  function finalizeDashboard() {
    document.getElementById('headerUsername').textContent = currentUser;
    document.getElementById('headerAvatar').textContent = currentAvatar;
    document.querySelectorAll('#addModal .paid-btn').forEach(b => {
      b.classList.toggle('selected', b.dataset.member === currentUser);
    });
    selectedPaidBy = currentUser;
    const dash = document.getElementById('dashboard');
    dash.style.display = 'block';
    setTimeout(() => dash.classList.add('show'), 50);
  }

  function logoutUser() {
    const dash = document.getElementById('dashboard');
    dash.classList.remove('show');
    setTimeout(() => {
      dash.style.display = 'none';
      clearPin();
      document.getElementById('successOverlay').classList.remove('show');
      const login = document.getElementById('loginScreen');
      login.style.display = 'flex';
      login.classList.remove('hide');
      login.classList.add('show');
      setTimeout(() => document.getElementById('p1').focus(), 300);
    }, 400);
  }

  // â”€â”€ Render expenses â”€â”€
  function renderExpenses(expenses) {
    const list = document.getElementById('expensesList');
    if (!expenses || expenses.length === 0) {
      list.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ’¸</div><p>No hay gastos aÃºn</p><small>Toca + para agregar el primero</small></div>`;
      return;
    }
    list.innerHTML = expenses.slice(0,10).map(e => {
      const date = e.createdAt?.toDate ? e.createdAt.toDate().toLocaleDateString('es-MX',{day:'numeric',month:'short'}) : 'Hoy';
      const emoji = catEmojis[e.category] || 'ğŸ“¦';
      const isSettle = e.type === 'settle';
      const splitLabel = e.split==='all'?'Todos':e.split==='two'?'2 personas':'Solo';
      return `
        <div class="expense-item" onclick="deleteExpensePrompt('${e.id}')">
          <div class="expense-emoji">${isSettle?'ğŸ¤':emoji}</div>
          <div class="expense-info">
            <div class="expense-desc">${e.description}</div>
            <div class="expense-meta">
              <span class="expense-who">${e.paidBy}</span>
              <span>${date}</span>
              ${!isSettle?`<span>Ã· ${splitLabel}</span>`:''}
            </div>
          </div>
          <div>
            <div class="expense-amount">$${parseFloat(e.amount).toFixed(2)}</div>
            ${isSettle?'<div class="expense-split green">Pago âœ“</div>':
            `<div class="expense-split">${e.split==='all'?'$'+(e.amount/3).toFixed(2)+' c/u':e.split==='two'?'$'+(e.amount/2).toFixed(2)+' c/u':'Solo'}</div>`}
          </div>
        </div>`;
    }).join('');
  }

  // â”€â”€ Balances â”€â”€
  // â”€â”€ Debt calculation engine â”€â”€
  function calcBalances(expenses) {
    const now = new Date();
    const monthly = (expenses||[]).filter(e => {
      if (!e.createdAt?.toDate) return true;
      const d = e.createdAt.toDate();
      return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear();
    });

    // net[A][B] = how much A owes B (positive = A owes B, negative = B owes A)
    const net = {};
    members.forEach(a => { net[a]={}; members.forEach(b => net[a][b]=0); });

    monthly.forEach(e => {
      if (e.type==='settle') {
        // settle: paidBy pays settledTo â†’ reduces debt
        const amt = parseFloat(e.amount)||0;
        if (e.settledTo) {
          net[e.paidBy][e.settledTo] -= amt;
          net[e.settledTo][e.paidBy] += amt;
        }
        return;
      }
      const amt = parseFloat(e.amount)||0;
      let debtors = [];
      if (e.split==='all') debtors = members.filter(m => m !== e.paidBy);
      else if (e.split==='two') {
        // Use the saved splitWith field, fallback to first other member
        const partner = e.splitWith || members.filter(m => m !== e.paidBy)[0];
        debtors = [partner].filter(m => m !== e.paidBy);
      }
      // solo: no one owes anything
      if (debtors.length > 0) {
        const share = amt / (debtors.length + 1);
        debtors.forEach(d => {
          net[d][e.paidBy] += share;
          net[e.paidBy][d] -= share;
        });
      }
    });

    // Simplify: compute final debts between each pair
    const debts = [];
    const processed = new Set();
    members.forEach(a => {
      members.forEach(b => {
        if (a===b) return;
        const key = [a,b].sort().join('-');
        if (processed.has(key)) return;
        processed.add(key);
        const owes = net[a][b]; // positive = a owes b
        if (Math.abs(owes) < 0.01) return; // settled
        if (owes > 0) debts.push({ from:a, to:b, amount:owes });
        else debts.push({ from:b, to:a, amount:-owes });
      });
    });

    return { debts, monthly };
  }

  function updateBalances(expenses) {
    const now = new Date();
    const { debts, monthly } = calcBalances(expenses);

    // Update top balance card â€” net position per member
    const netPos = { Diego:0, Leo:0, Julian:0 };
    debts.forEach(d => { netPos[d.from]-=d.amount; netPos[d.to]+=d.amount; });

    members.forEach(m => {
      const net = netPos[m];
      const el = document.getElementById('bal-'+m.toLowerCase());
      const st = document.getElementById('balst-'+m.toLowerCase());
      if (el) { el.textContent='$'+Math.abs(net).toFixed(2); el.className='bm-amount '+(net>=0?'positive':'negative'); }
      if (st) st.textContent = Math.abs(net)<0.01 ? 'âœ“ al dÃ­a' : net>0 ? 'â–² a favor' : 'â–¼ debe';
    });

    const total = monthly.filter(e=>e.type!=='settle').reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
    document.getElementById('totalMonth').textContent='$'+total.toFixed(2);
    const months=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    document.getElementById('balanceMonth').textContent=`${months[now.getMonth()]} ${now.getFullYear()}`;

    // Render debt summary cards
    renderDebtSummary(debts);
  }

  const avMap = { Diego:'ğŸ‘¨', Leo:'ğŸ‘¨', Julian:'ğŸ§’' };

  function renderDebtSummary(debts) {
    const el = document.getElementById('debtSummary');
    if (!el) return;
    if (debts.length === 0) {
      el.innerHTML = `<div class="debt-card settled"><div style="font-size:28px">ğŸ‰</div><div class="debt-info"><div class="debt-text ok"><strong>Â¡Todo al dÃ­a!</strong></div><div class="debt-sub">No hay deudas pendientes este mes</div></div></div>`;
      return;
    }
    el.innerHTML = debts.map(d => `
      <div class="debt-card">
        <div class="debt-avatar-row">
          <span class="debt-av">${avMap[d.from]}</span>
          <span class="debt-arrow">â†’</span>
          <span class="debt-av">${avMap[d.to]}</span>
        </div>
        <div class="debt-info">
          <div class="debt-text"><strong>${d.from}</strong> le debe a <strong>${d.to}</strong></div>
          <div class="debt-sub">Toca "Liquidar" para saldar</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;flex-shrink:0">
          <div class="debt-amount">$${d.amount.toFixed(2)}</div>
          <button class="settle-quick-btn" onclick="quickSettle('${d.from}','${d.to}',${d.amount.toFixed(2)})">Liquidar</button>
        </div>
      </div>`).join('');
  }

  function renderDebtDetail(debts, expenses) {
    const { monthly } = calcBalances(expenses);
    const paid = { Diego:0, Leo:0, Julian:0 };
    const owedTotal = { Diego:0, Leo:0, Julian:0 };

    monthly.filter(e=>e.type!=='settle').forEach(e => {
      const amt = parseFloat(e.amount)||0;
      paid[e.paidBy] = (paid[e.paidBy]||0) + amt;
      if (e.split==='all') members.forEach(m => owedTotal[m]=(owedTotal[m]||0)+amt/3);
      else if (e.split==='two') {
        const partner = e.splitWith || members.filter(m=>m!==e.paidBy)[0];
        const share=amt/2;
        if (partner) owedTotal[partner]=(owedTotal[partner]||0)+share;
        owedTotal[e.paidBy]=(owedTotal[e.paidBy]||0)+share;
      }
    });

    const el = document.getElementById('debtDetailContent');
    if (!el) return;

    const memberRows = members.map(m => {
      const net = paid[m] - owedTotal[m];
      return `<div class="detail-row">
        <div class="detail-label"><span>${avMap[m]}</span>${m}</div>
        <div>
          <div class="detail-value">PagÃ³ $${(paid[m]||0).toFixed(2)}</div>
          <div class="detail-value" style="font-size:11px;color:var(--muted)">Debe $${(owedTotal[m]||0).toFixed(2)}</div>
          <div class="detail-value ${net>=0?'pos':'neg'}">${net>=0?'â–²':'â–¼'} $${Math.abs(net).toFixed(2)}</div>
        </div>
      </div>`;
    }).join('');

    const debtRows = debts.length===0
      ? `<div style="text-align:center;padding:20px;color:var(--muted);font-size:13px">ğŸ‰ Â¡Sin deudas pendientes!</div>`
      : debts.map(d => `
        <div class="detail-row">
          <div class="detail-label">${avMap[d.from]} <strong>${d.from}</strong> â†’ ${avMap[d.to]} <strong>${d.to}</strong></div>
          <div style="display:flex;align-items:center;gap:8px">
            <div class="detail-value neg">$${d.amount.toFixed(2)}</div>
            <button class="settle-quick-btn" onclick="quickSettle('${d.from}','${d.to}',${d.amount.toFixed(2)});closeModal('debtModal')">Liquidar</button>
          </div>
        </div>`).join('');

    el.innerHTML = `
      <div style="margin-bottom:20px">
        <div class="section-title" style="margin-bottom:12px">Por persona</div>
        ${memberRows}
      </div>
      <div>
        <div class="section-title" style="margin-bottom:12px">Deudas pendientes</div>
        ${debtRows}
      </div>`;
  }

  function openDebtDetail() {
    const expenses = window._expenses || [];
    const { debts } = calcBalances(expenses);
    renderDebtDetail(debts, expenses);
    document.getElementById('debtModal').classList.add('show');
  }

  async function quickSettle(from, to, amount) {
    if (!confirm(`Â¿Registrar que ${from} le pagÃ³ $${amount.toFixed(2)} a ${to}?`)) return;
    try {
      await window._addDoc(window._collection(window._db,'expenses'),{
        amount, description:`${from} liquidÃ³ deuda con ${to}`,
        paidBy:from, settledTo:to,
        createdAt:window._serverTimestamp(), type:'settle', createdBy:currentUser
      });
      showToast(`âœ… Deuda liquidada â€” balance en $0`);
    } catch(e) { showToast('âŒ Error al registrar'); }
  }

  function updateBalances_old(expenses) {}

  // â”€â”€ Add expense â”€â”€
  async function addExpense() {
    const amount = parseFloat(document.getElementById('inputAmount').value);
    const desc = document.getElementById('inputDesc').value.trim();
    if (!amount||amount<=0) { showToast('âš ï¸ Ingresa un monto vÃ¡lido'); return; }
    if (!desc) { showToast('âš ï¸ Agrega una descripciÃ³n'); return; }
    if (!selectedPaidBy) { showToast('âš ï¸ Â¿QuiÃ©n pagÃ³?'); return; }
    if (selectedSplit==='two' && !selectedWithWhom) { showToast('âš ï¸ Â¿Con quiÃ©n compartes el gasto?'); return; }
    const btn = document.getElementById('submitBtn');
    btn.disabled=true; btn.textContent='Guardando...';
    try {
      await window._addDoc(window._collection(window._db,'expenses'),{
        amount, description:desc, category:selectedCat,
        paidBy:selectedPaidBy, split:selectedSplit,
        splitWith: selectedSplit==='two' ? selectedWithWhom : null,
        createdBy:currentUser, createdAt:window._serverTimestamp(), type:'expense'
      });
      closeModal('addModal'); showToast('âœ… Gasto agregado'); resetForm();
    } catch(e) { showToast('âŒ Error al guardar'); }
    btn.disabled=false; btn.textContent='Agregar gasto âœ“';
  }

  // â”€â”€ Add settle â”€â”€
  async function addSettle() {
    const amount = parseFloat(document.getElementById('settleAmount').value);
    if (!amount||amount<=0) { showToast('âš ï¸ Ingresa un monto'); return; }
    if (!settleFrom) { showToast('âš ï¸ Â¿QuiÃ©n paga?'); return; }
    if (!settleTo)   { showToast('âš ï¸ Â¿A quiÃ©n le paga?'); return; }
    if (settleFrom===settleTo) { showToast('âš ï¸ Selecciona personas diferentes'); return; }
    try {
      await window._addDoc(window._collection(window._db,'expenses'),{
        amount, description:`${settleFrom} le pagÃ³ a ${settleTo}`,
        paidBy:settleFrom, settledTo:settleTo,
        createdAt:window._serverTimestamp(), type:'settle', createdBy:currentUser
      });
      closeModal('settleModal'); showToast('âœ… Pago registrado');
      document.getElementById('settleAmount').value='';
      settleFrom=null; settleTo=null;
      document.querySelectorAll('#settleFromGrid .paid-btn, #settleToGrid .paid-btn').forEach(b=>b.classList.remove('selected'));
    } catch(e) { showToast('âŒ Error al guardar'); }
  }

  // â”€â”€ Delete â”€â”€
  async function deleteExpensePrompt(id) {
    if (!confirm('Â¿Eliminar este gasto?')) return;
    try { await window._deleteDoc(window._doc(window._db,'expenses',id)); showToast('ğŸ—‘ï¸ Eliminado'); }
    catch(e) { showToast('âŒ Error al eliminar'); }
  }

  // â”€â”€ Form helpers â”€â”€
  function selectCat(el) { document.querySelectorAll('.cat-pill').forEach(b=>b.classList.remove('selected')); el.classList.add('selected'); selectedCat=el.dataset.cat; }
  function selectPaidBy(el) {
    el.closest('.paid-grid').querySelectorAll('.paid-btn').forEach(b=>b.classList.remove('selected'));
    el.classList.add('selected');
    selectedPaidBy=el.dataset.member;
    // If split=two is active, refresh who can be selected as partner
    if (selectedSplit==='two') updateWithWhomGrid();
  }
  function selectSplit(el) {
    document.querySelectorAll('.split-btn').forEach(b=>b.classList.remove('selected'));
    el.classList.add('selected');
    selectedSplit=el.dataset.split;
    // Show/hide the "with whom" selector
    const group = document.getElementById('withWhomGroup');
    if (selectedSplit==='two') {
      group.style.display='block';
      // Hide the payer from the with-whom grid
      updateWithWhomGrid();
    } else {
      group.style.display='none';
      selectedWithWhom=null;
    }
  }

  let selectedWithWhom = null;

  function selectWithWhom(el) {
    document.getElementById('withWhomGrid').querySelectorAll('.paid-btn').forEach(b=>b.classList.remove('selected'));
    el.classList.add('selected');
    selectedWithWhom = el.dataset.member;
  }

  function updateWithWhomGrid() {
    // Hide the person who paid from the with-whom options
    document.getElementById('withWhomGrid').querySelectorAll('.paid-btn').forEach(b => {
      b.style.display = b.dataset.member === selectedPaidBy ? 'none' : 'flex';
      b.classList.remove('selected');
    });
    selectedWithWhom = null;
  }
  function selectSettleFrom(el) { document.getElementById('settleFromGrid').querySelectorAll('.paid-btn').forEach(b=>b.classList.remove('selected')); el.classList.add('selected'); settleFrom=el.dataset.member; }
  function selectSettleTo(el) { document.getElementById('settleToGrid').querySelectorAll('.paid-btn').forEach(b=>b.classList.remove('selected')); el.classList.add('selected'); settleTo=el.dataset.member; }

  function resetForm() {
    document.getElementById('inputAmount').value='';
    document.getElementById('inputDesc').value='';
    selectedPaidBy=currentUser; selectedSplit='all'; selectedCat='food';
    selectedWithWhom=null;
    document.querySelectorAll('.cat-pill').forEach((b,i)=>b.classList.toggle('selected',i===0));
    document.querySelectorAll('#addModal .paid-btn').forEach(b=>b.classList.toggle('selected',b.dataset.member===currentUser));
    document.querySelectorAll('.split-btn').forEach((b,i)=>b.classList.toggle('selected',i===0));
    document.getElementById('withWhomGroup').style.display='none';
    document.getElementById('withWhomGrid').querySelectorAll('.paid-btn').forEach(b=>{ b.classList.remove('selected'); b.style.display='flex'; });
  }

  // â”€â”€ Modal â”€â”€
  function openModal() { document.getElementById('addModal').classList.add('show'); setTimeout(()=>document.getElementById('inputAmount').focus(),400); }
  function openSettleModal() { document.getElementById('settleModal').classList.add('show'); }
  function closeModal(id) { document.getElementById(id).classList.remove('show'); }
  function closeOnOverlay(e,id) { if(e.target===document.getElementById(id)) closeModal(id); }

  // â”€â”€ Toast â”€â”€
  function showToast(msg) {
    const t=document.getElementById('toast');
    t.textContent=msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'),2500);
  }

  // â”€â”€ Nav â”€â”€
  function setTab(el) { document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active')); el.classList.add('active'); }

  // Expose
  // â”€â”€ STATS â”€â”€
  const catEmojisMap = { food:'ğŸ›’', transport:'ğŸš—', utilities:'ğŸ’¡', health:'ğŸ’Š', entertainment:'ğŸ¬', home:'ğŸ ', education:'ğŸ“š', other:'ğŸ“¦' };
  const catNames     = { food:'Comida', transport:'Transporte', utilities:'Servicios', health:'Salud', entertainment:'Ocio', home:'Casa', education:'EducaciÃ³n', other:'Otro' };
  const memberColors = { Diego:'diego', Leo:'leo', Julian:'julian' };

  function openStatsModal() {
    const expenses = window._expenses || [];
    const now = new Date();
    const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    document.getElementById('statsMonthLabel').textContent = months[now.getMonth()];

    const monthly = expenses.filter(e => {
      if (e.type==='settle') return false;
      if (!e.createdAt?.toDate) return true;
      const d = e.createdAt.toDate();
      return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear();
    });

    // â”€â”€ Total â”€â”€
    const total = monthly.reduce((s,e) => s+(parseFloat(e.amount)||0), 0);
    document.getElementById('statsTotalAmt').textContent = '$'+total.toFixed(2);

    // â”€â”€ Member totals â”€â”€
    const memberTotals = { Diego:0, Leo:0, Julian:0 };
    monthly.forEach(e => { memberTotals[e.paidBy] = (memberTotals[e.paidBy]||0) + (parseFloat(e.amount)||0); });
    const maxMember = Math.max(...Object.values(memberTotals), 1);

    document.getElementById('memberBars').innerHTML = members.map(m => {
      const amt = memberTotals[m] || 0;
      const pct = total > 0 ? Math.round(amt/total*100) : 0;
      const barW = Math.round(amt/maxMember*100);
      return `
        <div class="member-bar-row">
          <div class="member-bar-header">
            <div class="member-bar-name">${avMap[m]} ${m}</div>
            <div style="display:flex;gap:8px;align-items:center">
              <span class="member-bar-pct">${pct}%</span>
              <span class="member-bar-amt">$${amt.toFixed(2)}</span>
            </div>
          </div>
          <div class="bar-track">
            <div class="bar-fill ${memberColors[m]}" style="width:${barW}%" data-w="${barW}"></div>
          </div>
        </div>`;
    }).join('');

    // â”€â”€ Category totals â”€â”€
    const catTotals = {};
    monthly.forEach(e => {
      const cat = e.category || 'other';
      catTotals[cat] = (catTotals[cat]||0) + (parseFloat(e.amount)||0);
    });
    const sortedCats = Object.entries(catTotals).sort((a,b)=>b[1]-a[1]);
    const maxCat = sortedCats[0]?.[1] || 1;

    document.getElementById('categoryBars').innerHTML = sortedCats.length === 0
      ? `<div style="text-align:center;color:var(--muted);font-size:13px;padding:10px">Sin datos</div>`
      : sortedCats.map(([cat, amt]) => {
          const pct = total > 0 ? Math.round(amt/total*100) : 0;
          const barW = Math.round(amt/maxCat*100);
          return `
            <div class="cat-bar-row">
              <div class="cat-bar-header">
                <div class="cat-bar-name">${catEmojisMap[cat]||'ğŸ“¦'} ${catNames[cat]||cat}</div>
                <div style="display:flex;gap:8px;align-items:center">
                  <span style="font-size:11px;color:var(--muted)">${pct}%</span>
                  <span class="cat-bar-amt">$${amt.toFixed(2)}</span>
                </div>
              </div>
              <div class="bar-track"><div class="bar-fill cat" style="width:${barW}%" data-w="${barW}"></div></div>
            </div>`;
        }).join('');

    // â”€â”€ Top 5 expenses â”€â”€
    const top5 = [...monthly].sort((a,b)=>(parseFloat(b.amount)||0)-(parseFloat(a.amount)||0)).slice(0,5);
    const rankClass = ['gold','silver','bronze','',''];
    const rankEmoji = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4','5'];

    document.getElementById('topExpenses').innerHTML = top5.length === 0
      ? `<div style="text-align:center;color:var(--muted);font-size:13px;padding:10px">Sin gastos este mes</div>`
      : top5.map((e,i) => `
          <div class="top-expense-row">
            <div class="top-rank ${rankClass[i]}">${rankEmoji[i]}</div>
            <div class="top-info">
              <div class="top-desc">${e.description}</div>
              <div class="top-meta">${avMap[e.paidBy]} ${e.paidBy} Â· ${catEmojisMap[e.category]||'ğŸ“¦'} ${catNames[e.category]||'Otro'}</div>
            </div>
            <div class="top-amt">$${parseFloat(e.amount).toFixed(2)}</div>
          </div>`).join('');

    document.getElementById('statsModal').classList.add('show');

    // Animate bars after modal opens
    setTimeout(() => {
      document.querySelectorAll('.bar-fill').forEach(bar => {
        bar.style.width = bar.dataset.w + '%';
      });
    }, 100);
  }

  window.openStatsModal = openStatsModal;

  // â”€â”€ Register Service Worker (PWA) â”€â”€
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/Spentshare/sw.js')
        .then(() => console.log('âœ… SW registered'))
        .catch(e => console.log('SW error:', e));
    });
  } window.selectMember=selectMember; window.doLogin=doLogin;
  window.moveFocus=moveFocus; window.openModal=openModal; window.openSettleModal=openSettleModal;
  window.closeOnOverlay=closeOnOverlay; window.addExpense=addExpense; window.addSettle=addSettle;
  window.selectCat=selectCat; window.selectPaidBy=selectPaidBy; window.selectSplit=selectSplit;
  window.selectSettleFrom=selectSettleFrom; window.selectSettleTo=selectSettleTo;
  window.selectWithWhom=selectWithWhom;
  window.deleteExpensePrompt=deleteExpensePrompt; window.setTab=setTab; window.logoutUser=logoutUser;
  window.showToast=showToast; window.renderExpenses=renderExpenses; window.updateBalances=updateBalances;
  window.moveNewFocus=moveNewFocus; window.checkPinMatch=checkPinMatch; window.saveNewPin=saveNewPin;
  window.openDebtDetail=openDebtDetail; window.quickSettle=quickSettle;

  setLang('es');
</script>
</body>
</html>
