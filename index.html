<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SpentShare</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;900&family=Nunito+Sans:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --orange: #ff6b35;
    --orange-light: #fff5f0;
    --green: #3ecf8e;
    --green-light: #f0fdf8;
    --blue: #4f8ef7;
    --blue-light: #eff6ff;
    --red: #f56565;
    --red-light: #fff5f5;
    --cream: #f7f3ee;
    --white: #ffffff;
    --text: #1a1a2e;
    --text2: #555;
    --muted: #aaa;
    --border: #ede9e3;
    --card-shadow: 0 4px 20px rgba(0,0,0,0.06);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'Nunito Sans', sans-serif;
    background: var(--cream);
    color: var(--text);
    min-height: 100vh;
    padding-bottom: 80px;
  }

  /* â”€â”€â”€ HEADER â”€â”€â”€ */
  .header {
    background: white;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 12px rgba(0,0,0,0.05);
    position: sticky;
    top: 0;
    z-index: 50;
  }

  .header-logo {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .header-coin {
    width: 32px; height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--orange), #f7931e);
    display: flex; align-items: center; justify-content: center;
    font-size: 15px;
    box-shadow: 0 3px 10px rgba(255,107,53,0.3);
  }

  .header-name {
    font-family: 'Nunito', sans-serif;
    font-size: 18px;
    font-weight: 900;
    color: var(--text);
    letter-spacing: -0.5px;
  }
  .header-name span { color: var(--orange); }

  .header-user {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--cream);
    padding: 6px 12px 6px 8px;
    border-radius: 50px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .header-user:hover { background: var(--border); }
  .header-avatar { font-size: 20px; }
  .header-username {
    font-family: 'Nunito', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
  }

  /* â”€â”€â”€ MAIN CONTENT â”€â”€â”€ */
  .main { max-width: 480px; margin: 0 auto; padding: 20px 16px; }

  /* â”€â”€â”€ BALANCE CARD â”€â”€â”€ */
  .balance-card {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border-radius: 24px;
    padding: 24px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 12px 40px rgba(26,26,46,0.25);
  }

  .balance-card::before {
    content: '';
    position: absolute;
    width: 200px; height: 200px;
    background: var(--orange);
    border-radius: 50%;
    opacity: 0.08;
    top: -60px; right: -60px;
  }

  .balance-card::after {
    content: '';
    position: absolute;
    width: 150px; height: 150px;
    background: var(--green);
    border-radius: 50%;
    opacity: 0.06;
    bottom: -50px; left: -30px;
  }

  .balance-label {
    font-size: 11px;
    font-weight: 600;
    color: rgba(255,255,255,0.4);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .balance-month {
    font-family: 'Nunito', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: rgba(255,255,255,0.5);
    margin-bottom: 4px;
  }

  .balance-amount {
    font-family: 'Nunito', sans-serif;
    font-size: 44px;
    font-weight: 900;
    color: white;
    letter-spacing: -2px;
    margin-bottom: 20px;
    position: relative;
    z-index: 1;
  }

  .balance-members {
    display: flex;
    gap: 10px;
    position: relative;
    z-index: 1;
  }

  .balance-member {
    flex: 1;
    background: rgba(255,255,255,0.07);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 14px;
    padding: 10px 12px;
    backdrop-filter: blur(10px);
  }

  .bm-name {
    font-size: 11px;
    color: rgba(255,255,255,0.5);
    font-weight: 600;
    margin-bottom: 2px;
  }

  .bm-amount {
    font-family: 'Nunito', sans-serif;
    font-size: 16px;
    font-weight: 900;
    color: white;
  }

  .bm-amount.positive { color: var(--green); }
  .bm-amount.negative { color: #ff8a80; }

  .bm-status {
    font-size: 10px;
    color: rgba(255,255,255,0.35);
    margin-top: 1px;
  }

  /* â”€â”€â”€ QUICK ACTIONS â”€â”€â”€ */
  .section-title {
    font-family: 'Nunito', sans-serif;
    font-size: 14px;
    font-weight: 700;
    color: var(--muted);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    margin-bottom: 12px;
  }

  .quick-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 24px;
  }

  .qa-btn {
    background: white;
    border: none;
    border-radius: 18px;
    padding: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: var(--card-shadow);
    transition: all 0.2s;
    text-align: left;
  }

  .qa-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(0,0,0,0.1); }
  .qa-btn:active { transform: translateY(0); }

  .qa-icon {
    width: 44px; height: 44px;
    border-radius: 14px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
  }

  .qa-icon.orange { background: var(--orange-light); }
  .qa-icon.green  { background: var(--green-light); }
  .qa-icon.blue   { background: var(--blue-light); }
  .qa-icon.red    { background: var(--red-light); }

  .qa-label {
    font-family: 'Nunito', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
    line-height: 1.3;
  }

  /* â”€â”€â”€ EXPENSES LIST â”€â”€â”€ */
  .expenses-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .see-all {
    font-size: 12px;
    font-weight: 600;
    color: var(--orange);
    background: none;
    border: none;
    cursor: pointer;
    font-family: 'Nunito', sans-serif;
  }

  .expense-item {
    background: white;
    border-radius: 18px;
    padding: 14px 16px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 14px;
    box-shadow: var(--card-shadow);
    transition: all 0.2s;
    cursor: pointer;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .expense-item:hover { transform: translateX(4px); box-shadow: 0 6px 24px rgba(0,0,0,0.09); }

  .expense-emoji {
    width: 46px; height: 46px;
    border-radius: 14px;
    background: var(--cream);
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
    flex-shrink: 0;
  }

  .expense-info { flex: 1; min-width: 0; }

  .expense-desc {
    font-family: 'Nunito', sans-serif;
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .expense-meta {
    font-size: 12px;
    color: var(--muted);
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .expense-who {
    background: var(--cream);
    padding: 2px 7px;
    border-radius: 6px;
    font-weight: 600;
    color: var(--text2);
    font-size: 11px;
  }

  .expense-amount {
    font-family: 'Nunito', sans-serif;
    font-size: 16px;
    font-weight: 900;
    color: var(--text);
    flex-shrink: 0;
  }

  .expense-split {
    font-size: 11px;
    color: var(--muted);
    text-align: right;
    margin-top: 2px;
  }

  .expense-split.green { color: var(--green); }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
  }

  .empty-state .empty-icon { font-size: 48px; margin-bottom: 10px; }
  .empty-state p { font-size: 14px; font-weight: 600; }
  .empty-state small { font-size: 12px; }

  /* â”€â”€â”€ BOTTOM NAV â”€â”€â”€ */
  .bottom-nav {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: white;
    padding: 10px 20px 20px;
    display: flex;
    justify-content: space-around;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.06);
    z-index: 50;
  }

  .nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    cursor: pointer;
    padding: 6px 16px;
    border-radius: 14px;
    transition: all 0.2s;
    border: none;
    background: none;
  }

  .nav-item.active { background: var(--orange-light); }
  .nav-item .nav-icon { font-size: 22px; }
  .nav-item .nav-label {
    font-family: 'Nunito', sans-serif;
    font-size: 10px;
    font-weight: 700;
    color: var(--muted);
    letter-spacing: 0.5px;
  }
  .nav-item.active .nav-label { color: var(--orange); }

  /* â”€â”€â”€ FAB â”€â”€â”€ */
  .fab {
    position: fixed;
    bottom: 72px;
    right: 20px;
    width: 58px; height: 58px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--orange), #f7931e);
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    box-shadow: 0 8px 24px rgba(255,107,53,0.45);
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
    z-index: 60;
  }

  .fab:hover { transform: scale(1.1) rotate(90deg); box-shadow: 0 12px 32px rgba(255,107,53,0.55); }
  .fab:active { transform: scale(0.95); }

  /* â”€â”€â”€ MODAL â”€â”€â”€ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(26,26,46,0.5);
    z-index: 200;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    backdrop-filter: blur(4px);
  }

  .modal-overlay.show { opacity: 1; pointer-events: all; }

  .modal {
    background: white;
    border-radius: 28px 28px 0 0;
    padding: 28px 24px 40px;
    width: 100%;
    max-width: 480px;
    transform: translateY(100%);
    transition: transform 0.4s cubic-bezier(0.34,1.1,0.64,1);
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-overlay.show .modal { transform: translateY(0); }

  .modal-handle {
    width: 40px; height: 4px;
    background: var(--border);
    border-radius: 4px;
    margin: 0 auto 20px;
  }

  .modal-title {
    font-family: 'Nunito', sans-serif;
    font-size: 22px;
    font-weight: 900;
    color: var(--text);
    margin-bottom: 22px;
  }

  .form-group { margin-bottom: 18px; }

  .form-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    margin-bottom: 8px;
    display: block;
  }

  .form-input {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid var(--border);
    border-radius: 14px;
    font-family: 'Nunito', sans-serif;
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
    background: white;
    outline: none;
    transition: border-color 0.2s;
  }

  .form-input:focus { border-color: var(--orange); box-shadow: 0 0 0 4px rgba(255,107,53,0.08); }

  .amount-input {
    font-size: 32px;
    font-weight: 900;
    text-align: center;
    letter-spacing: -1px;
    color: var(--orange);
  }

  /* Category pills */
  .cat-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
  }

  .cat-pill {
    padding: 10px 6px;
    border: 2px solid var(--border);
    border-radius: 12px;
    background: white;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: all 0.15s;
  }

  .cat-pill:hover { border-color: var(--orange); background: var(--orange-light); }
  .cat-pill.selected { border-color: var(--orange); background: var(--orange-light); }
  .cat-pill .cat-emoji { font-size: 22px; }
  .cat-pill .cat-name { font-size: 10px; font-weight: 700; color: var(--text2); }

  /* Paid by */
  .paid-grid {
    display: flex;
    gap: 8px;
  }

  .paid-btn {
    flex: 1;
    padding: 12px 8px;
    border: 2px solid var(--border);
    border-radius: 14px;
    background: white;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: all 0.15s;
  }

  .paid-btn:hover { border-color: var(--blue); background: var(--blue-light); }
  .paid-btn.selected { border-color: var(--blue); background: var(--blue-light); }
  .paid-btn .paid-avatar { font-size: 24px; }
  .paid-btn .paid-name { font-size: 12px; font-weight: 700; color: var(--text); }

  /* Split between */
  .split-grid {
    display: flex;
    gap: 8px;
  }

  .split-btn {
    flex: 1;
    padding: 10px;
    border: 2px solid var(--border);
    border-radius: 12px;
    background: white;
    cursor: pointer;
    font-size: 11px;
    font-weight: 700;
    color: var(--text2);
    font-family: 'Nunito', sans-serif;
    transition: all 0.15s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }

  .split-btn .split-emoji { font-size: 18px; }
  .split-btn:hover { border-color: var(--green); background: var(--green-light); }
  .split-btn.selected { border-color: var(--green); background: var(--green-light); color: #1a7a52; }

  /* Submit btn */
  .submit-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--orange), #f7931e);
    border: none;
    border-radius: 16px;
    font-family: 'Nunito', sans-serif;
    font-size: 16px;
    font-weight: 900;
    color: white;
    cursor: pointer;
    box-shadow: 0 8px 24px rgba(255,107,53,0.35);
    transition: all 0.2s;
    margin-top: 8px;
  }

  .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(255,107,53,0.45); }
  .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  /* â”€â”€â”€ TOAST â”€â”€â”€ */
  .toast {
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(-20px);
    background: var(--text);
    color: white;
    padding: 12px 20px;
    border-radius: 50px;
    font-family: 'Nunito', sans-serif;
    font-size: 13px;
    font-weight: 700;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s;
    z-index: 999;
    white-space: nowrap;
  }

  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* â”€â”€â”€ SYNC STATUS â”€â”€â”€ */
  .sync-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--green);
    display: inline-block;
    margin-right: 4px;
    animation: pulse 2s infinite;
  }

  .sync-dot.offline { background: var(--muted); animation: none; }

  @keyframes pulse {
    0%,100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .sync-label {
    font-size: 11px;
    color: var(--muted);
    display: flex;
    align-items: center;
    margin-bottom: 16px;
  }

  /* Loading skeleton */
  .skeleton {
    background: linear-gradient(90deg, #f0ece7 25%, #e8e4df 50%, #f0ece7 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 18px;
    height: 70px;
    margin-bottom: 8px;
  }

  @keyframes shimmer {
    from { background-position: 200% 0; }
    to   { background-position: -200% 0; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-logo">
    <div class="header-coin">ğŸ’°</div>
    <div class="header-name">Spent<span>Share</span></div>
  </div>
  <div class="header-user" onclick="logout()">
    <div class="header-avatar" id="headerAvatar">ğŸ‘¨</div>
    <div class="header-username" id="headerUsername">Julian</div>
  </div>
</div>

<!-- MAIN -->
<div class="main">

  <!-- Sync status -->
  <div class="sync-label">
    <span class="sync-dot" id="syncDot"></span>
    <span id="syncLabel">Conectado a Firebase</span>
  </div>

  <!-- Balance Card -->
  <div class="balance-card">
    <div class="balance-label">Gastos del mes</div>
    <div class="balance-month" id="balanceMonth">Febrero 2026</div>
    <div class="balance-amount" id="totalMonth">$0.00</div>
    <div class="balance-members" id="balanceMembers">
      <div class="balance-member">
        <div class="bm-name">Diego</div>
        <div class="bm-amount" id="bal-diego">$0.00</div>
        <div class="bm-status" id="balst-diego">â€”</div>
      </div>
      <div class="balance-member">
        <div class="bm-name">Leo</div>
        <div class="bm-amount" id="bal-leo">$0.00</div>
        <div class="bm-status" id="balst-leo">â€”</div>
      </div>
      <div class="balance-member">
        <div class="bm-name">Julian</div>
        <div class="bm-amount" id="bal-julian">$0.00</div>
        <div class="bm-status" id="balst-julian">â€”</div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="section-title">Acciones rÃ¡pidas</div>
  <div class="quick-actions">
    <button class="qa-btn" onclick="openModal()">
      <div class="qa-icon orange">â•</div>
      <div class="qa-label">Agregar gasto</div>
    </button>
    <button class="qa-btn" onclick="openSettleModal()">
      <div class="qa-icon green">ğŸ¤</div>
      <div class="qa-label">Liquidar deuda</div>
    </button>
    <button class="qa-btn" onclick="showHistory()">
      <div class="qa-icon blue">ğŸ“Š</div>
      <div class="qa-label">Ver historial</div>
    </button>
    <button class="qa-btn" onclick="showStats()">
      <div class="qa-icon red">ğŸ“ˆ</div>
      <div class="qa-label">EstadÃ­sticas</div>
    </button>
  </div>

  <!-- Recent Expenses -->
  <div class="expenses-header">
    <div class="section-title" style="margin:0">Gastos recientes</div>
    <button class="see-all" onclick="showHistory()">Ver todos â†’</button>
  </div>

  <div id="loadingSkeletons">
    <div class="skeleton"></div>
    <div class="skeleton"></div>
    <div class="skeleton"></div>
  </div>

  <div id="expensesList"></div>

</div>

<!-- FAB -->
<button class="fab" onclick="openModal()" title="Agregar gasto">+</button>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button class="nav-item active" onclick="setTab(this)">
    <span class="nav-icon">ğŸ </span>
    <span class="nav-label">Inicio</span>
  </button>
  <button class="nav-item" onclick="setTab(this); showHistory()">
    <span class="nav-icon">ğŸ“‹</span>
    <span class="nav-label">Historial</span>
  </button>
  <button class="nav-item" onclick="setTab(this); showStats()">
    <span class="nav-icon">ğŸ“Š</span>
    <span class="nav-label">Stats</span>
  </button>
  <button class="nav-item" onclick="setTab(this)">
    <span class="nav-icon">âš™ï¸</span>
    <span class="nav-label">Config</span>
  </button>
</div>

<!-- â•â•â• ADD EXPENSE MODAL â•â•â• -->
<div class="modal-overlay" id="addModal" onclick="closeOnOverlay(event,'addModal')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ’¸ Nuevo gasto</div>

    <!-- Amount -->
    <div class="form-group">
      <label class="form-label">Monto</label>
      <input class="form-input amount-input" type="number" id="inputAmount" placeholder="$0.00" min="0" step="0.01">
    </div>

    <!-- Description -->
    <div class="form-group">
      <label class="form-label">DescripciÃ³n</label>
      <input class="form-input" type="text" id="inputDesc" placeholder="ej. Despensa, gasolina...">
    </div>

    <!-- Category -->
    <div class="form-group">
      <label class="form-label">CategorÃ­a</label>
      <div class="cat-grid">
        <button class="cat-pill selected" data-cat="food" onclick="selectCat(this)">
          <span class="cat-emoji">ğŸ›’</span><span class="cat-name">Comida</span>
        </button>
        <button class="cat-pill" data-cat="transport" onclick="selectCat(this)">
          <span class="cat-emoji">ğŸš—</span><span class="cat-name">Transporte</span>
        </button>
        <button class="cat-pill" data-cat="utilities" onclick="selectCat(this)">
          <span class="cat-emoji">ğŸ’¡</span><span class="cat-name">Servicios</span>
        </button>
        <button class="cat-pill" data-cat="health" onclick="selectCat(this)">
          <span class="cat-emoji">ğŸ’Š</span><span class="cat-name">Salud</span>
        </button>
        <button class="cat-pill" data-cat="entertainment" onclick="selectCat(this)">
          <span class="cat-emoji">ğŸ¬</span><span class="cat-name">Ocio</span>
        </button>
        <button class="cat-pill" data-cat="home" onclick="selectCat(this)">
          <span class="cat-emoji">ğŸ </span><span class="cat-name">Casa</span>
        </button>
        <button class="cat-pill" data-cat="education" onclick="selectCat(this)">
          <span class="cat-emoji">ğŸ“š</span><span class="cat-name">EducaciÃ³n</span>
        </button>
        <button class="cat-pill" data-cat="other" onclick="selectCat(this)">
          <span class="cat-emoji">ğŸ“¦</span><span class="cat-name">Otro</span>
        </button>
      </div>
    </div>

    <!-- Paid by -->
    <div class="form-group">
      <label class="form-label">Â¿QuiÃ©n pagÃ³?</label>
      <div class="paid-grid">
        <button class="paid-btn" data-member="Diego" onclick="selectPaidBy(this)">
          <span class="paid-avatar">ğŸ‘¨</span><span class="paid-name">Diego</span>
        </button>
        <button class="paid-btn" data-member="Leo" onclick="selectPaidBy(this)">
          <span class="paid-avatar">ğŸ‘¨</span><span class="paid-name">Leo</span>
        </button>
        <button class="paid-btn" data-member="Julian" onclick="selectPaidBy(this)">
          <span class="paid-avatar">ğŸ§’</span><span class="paid-name">Julian</span>
        </button>
      </div>
    </div>

    <!-- Split between -->
    <div class="form-group">
      <label class="form-label">Â¿Entre quiÃ©nes se divide?</label>
      <div class="split-grid">
        <button class="split-btn selected" data-split="all" onclick="selectSplit(this)">
          <span class="split-emoji">ğŸ‘¥</span>Todos
        </button>
        <button class="split-btn" data-split="two" onclick="selectSplit(this)">
          <span class="split-emoji">ğŸ‘¤</span>Dos personas
        </button>
        <button class="split-btn" data-split="solo" onclick="selectSplit(this)">
          <span class="split-emoji">ğŸ§¾</span>Solo yo
        </button>
      </div>
    </div>

    <button class="submit-btn" id="submitBtn" onclick="addExpense()">Agregar gasto âœ“</button>
  </div>
</div>

<!-- â•â•â• SETTLE MODAL â•â•â• -->
<div class="modal-overlay" id="settleModal" onclick="closeOnOverlay(event,'settleModal')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ¤ Liquidar deuda</div>

    <div class="form-group">
      <label class="form-label">Â¿QuiÃ©n paga?</label>
      <div class="paid-grid">
        <button class="paid-btn" data-member="Diego" onclick="selectSettleFrom(this)">
          <span class="paid-avatar">ğŸ‘¨</span><span class="paid-name">Diego</span>
        </button>
        <button class="paid-btn" data-member="Leo" onclick="selectSettleFrom(this)">
          <span class="paid-avatar">ğŸ‘¨</span><span class="paid-name">Leo</span>
        </button>
        <button class="paid-btn" data-member="Julian" onclick="selectSettleFrom(this)">
          <span class="paid-avatar">ğŸ§’</span><span class="paid-name">Julian</span>
        </button>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Â¿A quiÃ©n le paga?</label>
      <div class="paid-grid">
        <button class="paid-btn" data-member="Diego" onclick="selectSettleTo(this)">
          <span class="paid-avatar">ğŸ‘¨</span><span class="paid-name">Diego</span>
        </button>
        <button class="paid-btn" data-member="Leo" onclick="selectSettleTo(this)">
          <span class="paid-avatar">ğŸ‘¨</span><span class="paid-name">Leo</span>
        </button>
        <button class="paid-btn" data-member="Julian" onclick="selectSettleTo(this)">
          <span class="paid-avatar">ğŸ§’</span><span class="paid-name">Julian</span>
        </button>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Monto</label>
      <input class="form-input amount-input" type="number" id="settleAmount" placeholder="$0.00" min="0" step="0.01">
    </div>

    <button class="submit-btn" onclick="addSettle()">Registrar pago âœ“</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- â”€â”€â”€ FIREBASE â”€â”€â”€ -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, onSnapshot,
    query, orderBy, serverTimestamp, doc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB-KQnjwvoRvUciDDFR5eHOjwGZbh8DBZI",
    authDomain: "spendshare-ed3fa.firebaseapp.com",
    projectId: "spendshare-ed3fa",
    storageBucket: "spendshare-ed3fa.firebasestorage.app",
    messagingSenderId: "142707923361",
    appId: "1:142707923361:web:55b965b821dfa336b413e0"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // â”€â”€â”€ Expose to window for button handlers â”€â”€â”€
  window._db = db;
  window._addDoc = addDoc;
  window._collection = collection;
  window._serverTimestamp = serverTimestamp;
  window._deleteDoc = deleteDoc;
  window._doc = doc;

  // â”€â”€â”€ Real-time listener â”€â”€â”€
  const q = query(collection(db, 'expenses'), orderBy('createdAt', 'desc'));

  onSnapshot(q, (snapshot) => {
    document.getElementById('syncDot').classList.remove('offline');
    document.getElementById('syncLabel').textContent = 'Sincronizado';

    const expenses = [];
    snapshot.forEach(d => expenses.push({ id: d.id, ...d.data() }));

    window._expenses = expenses;
    renderExpenses(expenses);
    updateBalances(expenses);

    document.getElementById('loadingSkeletons').style.display = 'none';
  }, (err) => {
    console.error(err);
    document.getElementById('syncDot').classList.add('offline');
    document.getElementById('syncLabel').textContent = 'Sin conexiÃ³n';
    document.getElementById('loadingSkeletons').style.display = 'none';
  });
</script>

<script>
  // â”€â”€â”€ State â”€â”€â”€
  let currentUser = 'Julian';
  let selectedCat = 'food';
  let selectedPaidBy = null;
  let selectedSplit = 'all';
  let settleFrom = null;
  let settleTo = null;

  const members = ['Diego', 'Leo', 'Julian'];
  const avatars = { Diego: 'ğŸ‘¨', Leo: 'ğŸ‘¨', Julian: 'ğŸ§’' };

  const catEmojis = {
    food:'ğŸ›’', transport:'ğŸš—', utilities:'ğŸ’¡', health:'ğŸ’Š',
    entertainment:'ğŸ¬', home:'ğŸ ', education:'ğŸ“š', other:'ğŸ“¦'
  };

  // â”€â”€â”€ Render expenses â”€â”€â”€
  function renderExpenses(expenses) {
    const list = document.getElementById('expensesList');
    if (!expenses || expenses.length === 0) {
      list.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">ğŸ’¸</div>
          <p>No hay gastos aÃºn</p>
          <small>Toca + para agregar el primero</small>
        </div>`;
      return;
    }

    // Show last 10
    const recent = expenses.slice(0, 10);
    list.innerHTML = recent.map(e => {
      const date = e.createdAt?.toDate ? e.createdAt.toDate().toLocaleDateString('es-MX', {day:'numeric',month:'short'}) : 'Hoy';
      const emoji = catEmojis[e.category] || 'ğŸ“¦';
      const splitLabel = e.split === 'all' ? 'Todos' : e.split === 'two' ? '2 personas' : 'Solo';
      const isSettle = e.type === 'settle';

      return `
        <div class="expense-item" onclick="deleteExpensePrompt('${e.id}')">
          <div class="expense-emoji">${isSettle ? 'ğŸ¤' : emoji}</div>
          <div class="expense-info">
            <div class="expense-desc">${e.description}</div>
            <div class="expense-meta">
              <span class="expense-who">${e.paidBy}</span>
              <span>${date}</span>
              ${!isSettle ? `<span>Ã· ${splitLabel}</span>` : ''}
            </div>
          </div>
          <div>
            <div class="expense-amount">$${parseFloat(e.amount).toFixed(2)}</div>
            ${isSettle ? '<div class="expense-split green">Pago</div>' : `<div class="expense-split">${getSplitAmount(e)}</div>`}
          </div>
        </div>`;
    }).join('');
  }

  function getSplitAmount(e) {
    if (e.split === 'all') return `$${(e.amount / 3).toFixed(2)} c/u`;
    if (e.split === 'two') return `$${(e.amount / 2).toFixed(2)} c/u`;
    return 'Solo pago';
  }

  // â”€â”€â”€ Update balances â”€â”€â”€
  function updateBalances(expenses) {
    const now = new Date();
    const monthExpenses = (expenses || []).filter(e => {
      if (!e.createdAt?.toDate) return true;
      const d = e.createdAt.toDate();
      return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    });

    // Simple balance: paid - owed
    const paid = { Diego:0, Leo:0, Julian:0 };
    const owed = { Diego:0, Leo:0, Julian:0 };

    monthExpenses.forEach(e => {
      if (e.type === 'settle') return;
      const amt = parseFloat(e.amount) || 0;
      paid[e.paidBy] = (paid[e.paidBy] || 0) + amt;

      if (e.split === 'all') {
        members.forEach(m => { owed[m] = (owed[m]||0) + amt/3; });
      } else if (e.split === 'two') {
        // split between payer + one other (simplified)
        owed[e.paidBy] = (owed[e.paidBy]||0) + amt/2;
      }
      // solo: only payer owes
    });

    // Settle payments affect balances
    monthExpenses.forEach(e => {
      if (e.type !== 'settle') return;
      const amt = parseFloat(e.amount) || 0;
      paid[e.paidBy] = (paid[e.paidBy]||0) + amt;
      paid[e.settledTo] = (paid[e.settledTo]||0) - amt;
    });

    let total = 0;
    members.forEach(m => {
      const net = (paid[m]||0) - (owed[m]||0);
      total += paid[m]||0;
      const el = document.getElementById('bal-' + m.toLowerCase());
      const st = document.getElementById('balst-' + m.toLowerCase());
      if (el) {
        el.textContent = '$' + Math.abs(net).toFixed(2);
        el.className = 'bm-amount ' + (net >= 0 ? 'positive' : 'negative');
        if (st) st.textContent = net >= 0 ? 'â–² a favor' : 'â–¼ debe';
      }
    });

    const monthTotal = monthExpenses
      .filter(e => e.type !== 'settle')
      .reduce((s, e) => s + (parseFloat(e.amount)||0), 0);

    document.getElementById('totalMonth').textContent = '$' + monthTotal.toFixed(2);

    const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    document.getElementById('balanceMonth').textContent = `${months[now.getMonth()]} ${now.getFullYear()}`;
  }

  // â”€â”€â”€ Add expense â”€â”€â”€
  async function addExpense() {
    const amount = parseFloat(document.getElementById('inputAmount').value);
    const desc = document.getElementById('inputDesc').value.trim();

    if (!amount || amount <= 0) { showToast('âš ï¸ Ingresa un monto vÃ¡lido'); return; }
    if (!desc) { showToast('âš ï¸ Agrega una descripciÃ³n'); return; }
    if (!selectedPaidBy) { showToast('âš ï¸ Â¿QuiÃ©n pagÃ³?'); return; }

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.textContent = 'Guardando...';

    try {
      await window._addDoc(window._collection(window._db, 'expenses'), {
        amount,
        description: desc,
        category: selectedCat,
        paidBy: selectedPaidBy,
        split: selectedSplit,
        createdBy: currentUser,
        createdAt: window._serverTimestamp(),
        type: 'expense'
      });

      closeModal('addModal');
      showToast('âœ… Gasto agregado');
      resetForm();
    } catch(err) {
      console.error(err);
      showToast('âŒ Error al guardar');
    }

    btn.disabled = false;
    btn.textContent = 'Agregar gasto âœ“';
  }

  // â”€â”€â”€ Add settle â”€â”€â”€
  async function addSettle() {
    const amount = parseFloat(document.getElementById('settleAmount').value);
    if (!amount || amount <= 0) { showToast('âš ï¸ Ingresa un monto'); return; }
    if (!settleFrom) { showToast('âš ï¸ Â¿QuiÃ©n paga?'); return; }
    if (!settleTo)   { showToast('âš ï¸ Â¿A quiÃ©n le paga?'); return; }
    if (settleFrom === settleTo) { showToast('âš ï¸ Selecciona personas diferentes'); return; }

    try {
      await window._addDoc(window._collection(window._db, 'expenses'), {
        amount,
        description: `${settleFrom} le pagÃ³ a ${settleTo}`,
        paidBy: settleFrom,
        settledTo: settleTo,
        createdAt: window._serverTimestamp(),
        type: 'settle',
        createdBy: currentUser
      });

      closeModal('settleModal');
      showToast(`âœ… Pago registrado`);
      document.getElementById('settleAmount').value = '';
      settleFrom = null; settleTo = null;
    } catch(err) {
      showToast('âŒ Error al guardar');
    }
  }

  // â”€â”€â”€ Delete expense â”€â”€â”€
  async function deleteExpensePrompt(id) {
    if (!confirm('Â¿Eliminar este gasto?')) return;
    try {
      await window._deleteDoc(window._doc(window._db, 'expenses', id));
      showToast('ğŸ—‘ï¸ Gasto eliminado');
    } catch(err) {
      showToast('âŒ Error al eliminar');
    }
  }

  // â”€â”€â”€ Form helpers â”€â”€â”€
  function selectCat(el) {
    document.querySelectorAll('.cat-pill').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    selectedCat = el.dataset.cat;
  }

  function selectPaidBy(el) {
    el.closest('.paid-grid').querySelectorAll('.paid-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    selectedPaidBy = el.dataset.member;
  }

  function selectSplit(el) {
    document.querySelectorAll('.split-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    selectedSplit = el.dataset.split;
  }

  function selectSettleFrom(el) {
    el.closest('.paid-grid').querySelectorAll('.paid-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    settleFrom = el.dataset.member;
  }

  function selectSettleTo(el) {
    // find the second paid-grid
    const grids = document.querySelectorAll('#settleModal .paid-grid');
    grids[1].querySelectorAll('.paid-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    settleTo = el.dataset.member;
  }

  function resetForm() {
    document.getElementById('inputAmount').value = '';
    document.getElementById('inputDesc').value = '';
    selectedPaidBy = null;
    selectedSplit = 'all';
    selectedCat = 'food';
    document.querySelectorAll('.cat-pill').forEach((b,i) => b.classList.toggle('selected', i===0));
    document.querySelectorAll('.paid-btn').forEach(b => b.classList.remove('selected'));
    document.querySelectorAll('.split-btn').forEach((b,i) => b.classList.toggle('selected', i===0));
  }

  // â”€â”€â”€ Modal â”€â”€â”€
  function openModal() {
    // Auto-select current user as payer
    document.querySelectorAll('#addModal .paid-btn').forEach(b => {
      b.classList.toggle('selected', b.dataset.member === currentUser);
    });
    selectedPaidBy = currentUser;
    document.getElementById('addModal').classList.add('show');
    setTimeout(() => document.getElementById('inputAmount').focus(), 400);
  }

  function openSettleModal() {
    document.getElementById('settleModal').classList.add('show');
  }

  function closeModal(id) {
    document.getElementById(id).classList.remove('show');
  }

  function closeOnOverlay(e, id) {
    if (e.target === document.getElementById(id)) closeModal(id);
  }

  // â”€â”€â”€ Toast â”€â”€â”€
  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
  }

  // â”€â”€â”€ Nav â”€â”€â”€
  function setTab(el) {
    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
  }

  function showHistory() { showToast('ğŸ“‹ Historial â€” prÃ³ximamente'); }
  function showStats()   { showToast('ğŸ“Š EstadÃ­sticas â€” prÃ³ximamente'); }
  function logout()      { showToast('ğŸ‘‹ Hasta luego, ' + currentUser); }

  // Expose functions
  window.openModal = openModal;
  window.openSettleModal = openSettleModal;
  window.closeOnOverlay = closeOnOverlay;
  window.addExpense = addExpense;
  window.addSettle = addSettle;
  window.selectCat = selectCat;
  window.selectPaidBy = selectPaidBy;
  window.selectSplit = selectSplit;
  window.selectSettleFrom = selectSettleFrom;
  window.selectSettleTo = selectSettleTo;
  window.deleteExpensePrompt = deleteExpensePrompt;
  window.showHistory = showHistory;
  window.showStats = showStats;
  window.setTab = setTab;
  window.logout = logout;
</script>

</body>
</html>
